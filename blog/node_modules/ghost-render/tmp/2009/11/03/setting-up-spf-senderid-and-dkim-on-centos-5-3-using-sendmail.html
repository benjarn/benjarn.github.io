<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Setting up SPF, SenderID and DKIM on Centos 5.3 using sendmail</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Setting up SPF, SenderID and DKIM on Centos 5.3 using sendmail">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Setting up SPF, SenderID and DKIM on Centos 5.3 using sendmail">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2009/11/03/setting-up-spf-senderid-and-dkim-on-centos-5-3-using-sendmail.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2009/11/03/setting-up-spf-senderid-and-dkim-on-centos-5-3-using-sendmail.html" itemprop="url">Setting up SPF, SenderID and DKIM on Centos 5.3 using sendmail</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2009-11-03" itemprop="datePublished">November 03, 2009</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>The biggest four email providers Gmail, AOL, Hotmail and Yahoo (in this order <a href="http://www.informationweek.com/news/internet/google/showArticle.jhtml?articleID=219400298">according to Comscore</a>) all implement some form of anti-spam techniques.</p>
<p>The main technologies are reverse DNS checking, SPF, SenderID, Domainkeys and DKIM. I will discuss all of these here and provide my tips on setting up SPF, SenderID and DKIM. Please keep in mind that I am not an expert on email servers - but I hope this helps someone! It took me about half a day to figure this all out, so it is probably worth doing to improve your email delivery rates.</p>
<p><a href="http://zohrob.com/posts/entrepreneurs-guide-to-email-delivery-part-2.html">This blog entry from Dave Zohrom provides a nice discussion of sending email to a general audience</a> (part 2 of a 3-post series).</p>
<p><h2>Introduction</h2>
<strong>SPF or Sender Policy Framework</strong></p>
<p>SPF is easy to setup. It uses DNS TXT records to allow the email providers to check which servers are authorized to send email for a particular domain. The SPF project has done a great<strong> </strong>job at making this simple to setup. Just <a href="http://www.openspf.org/">go to their homepage</a> and use the setup wizard to generate the appropriate TXT records (the text field underneath &quot;Deploying SPF&quot;). Then change the values in your DNS records.</p>
<p>One thing to note is that if you have multiple servers and send email from a server with a different hostname (e.g. &quot;mail.example.com&quot;), you need to setup a record for that server as well. See <a href="http://www.openspf.org/FAQ/Common_mistakes">the common mistakes page on the SPF site</a>. Also, if you have hostnames that are not supposed to send mail, you ought to indicate this as well.</p>
<p>Another thing is that if you are using Google Apps for Your Domain to send email, then you will need to have to add &quot;include:aspmx.googlemail.com&quot; to also allow mail from Google to validate. See <a href="http://www.google.com/support/a/bin/answer.py?hl=en&amp;answer=33786">this answer for more</a>.</p>
<p><strong>SenderID from Microsoft</strong></p>
<p>SenderID is a variant of SPF, which for most practical cases is the same as SPF. Just setup SPF and this should produce a validation pass for SenderID as well. The semantics of the validation are a bit different,  but this does not seem to be a major practical problem. See testing tips below to make sure that this is also true in your case.</p>
<p><strong>DomainKeys</strong></p>
<p>DomainKeys is an older version of DKIM (DomainKeys Identified Mail) developed by Yahoo. Despite having very similar names, these ARE NOT the same!</p>
<p>Both DomainKeys and DKIM store public key information in DNS records and sign the message headers of every email sent. The recipient can then verify the signature.</p>
<p>DomainKeys was deprecated in 2007, but some email providers may still be using it. However, <a href="http://blog.deliverability.com/2009/09/franck-martin-on-the-future-of-dkim-and-domainbased-reputation-.html">these are a shrinking minority </a>and Yahoo does support the newer DKIM. <span style="background-color: #ffffff;">Because of this I did not add DomainKeys support but opted only to use DKIM.</span></p>
<p><span style="background-color: #ffffff;">You can add it to sendmail or Postfix using the dk-milter project code, but the unofficial RPM release <a href="http://www.topdog-software.com/oss/dk-milter/">is not maintained anymore</a>, which means you will need to install it from source (<a href="http://sourceforge.net/projects/dk-milter/">available via SourceForge</a>).</span></p>
<p><span style="background-color: #ffffff;"><strong>DKIM, or DomainKeys Identified Mail</strong></span></p>
<p><span style="background-color: #ffffff;">DKIM on the other hand seems to be gaining momentum. It is used by Gmail, Yahoo and AOL and many others, and also works by publishing public keys via DNS TXT records and by signing the emails at the email server.</span></p>
<p><span style="background-color: #ffffff;">To setup DKIM, you need an additional filter which takes the completed email and adds the DKIM signature to the email prior to sending it out.</span></p>
<p><span style="background-color: #ffffff;">Postfix and sendmail support &quot;<a href="http://en.wikipedia.org/wiki/Milter">milters</a>&quot;, which is apparently short for &quot;mail filter&quot;. There is a DKIM-milter package available for Centos at the EPEL repositories (see <a href="http://wiki.centos.org/AdditionalResources/Repositories">Centos page for 3rd party repos</a>).</span></p>
<p><h2><span style="background-color: #ffffff;">Setting up DKIM-milter with sendmail</span></h2>
<strong>Updated: Linked tutorial is DEAD. Here are the steps:</strong></p>
<p><strong>Step 1. Generate a private key</strong></p>
<p>openssl genrsa -out default.private 1024</p>
<p>A “default.private” key file will be generated. It will be moved to a specific location later.</p>
<p><strong>Step 2. Generate a public key for this private key</strong></p>
<p>openssl rsa -in default.private -pubout -out default.public -outform PEM</p>
<p>A file with filename “default.public” will be generated with content like</p>
<p>-----BEGIN PUBLIC KEY-----</p>
<p>...</p>
<p>-----END PUBLIC KEY----</p>
<p>It will be used to create a DNS TXT record. See next step.</p>
<p><strong>Step 3. Create a DNS record of type TXT</strong></p>
<p>Modify DNS records and add a record of type TXT:</p>
<p>TXT record name</p>
<p>default._domainkey</p>
<p>TXT record value</p>
<p>v=DKIM1; g=*; k=rsa; p=&lt;content of default.public&gt;</p>
<p>Note that the prefix “—–BEGIN PUBLIC KEY—–” and suffix “—–END PUBLIC KEY—-” should not be put in the TXT record value.</p>
<p>This DNS record will be retrieved by mail receivers who want to verify emails with DKIM signatures. The record name “default._domainkey” tells verifier that the “selector” of this signature is “default”, therefore if you are changing selector name to something else, make sure you change all of them consistently.</p>
<p><strong>Step 4. Install dkim-milter in Fedora</strong></p>
<p>Run the following as root to install the dkim-milter pacakge.</p>
<p>yum install dkim-milter</p>
<p><strong>Step 5. Enable dkim-milter to run on start-up</strong></p>
<p>Make sure dkim-milter service will run on start-up by running this command:</p>
<p>chkconfig --level 3 dkim-milter on</p>
<p>Note that your server may use a different “runlevel”. You can check “/etc/inittab” to see which run level you are on.</p>
<p><strong>Step 6. Move private key to appropriate location</strong></p>
<p>As root, copy the private key to the location specified by the “keylist” (refer to next step) and make sure it is readable by dkim-milter:</p>
<p>mkdir /etc/dkim-milter/</p>
<p>mv default.private /etc/dkim-milter/default</p>
<p>chown dkim-milter.dkim-milter /etc/dkim-milter/default</p>
<p>Make sure the filename of private key file matches the “selector” name specified in the DNS record.</p>
<p><strong>Step 7. Add an entry to the keylist for dkim-milter to read</strong></p>
<p>Add the following line to /etc/mail/dkim-milter/keys/keylist. Replace &lt;domain.com&gt; with your domain name.</p>
<p>*:&lt;domain.com&gt;:/etc/dkim-milter/default</p>
<p><span style="background-color: #ffffff;"><strong>Step 8. Configure dkim-milter</strong></span></p>
<p><span style="background-color: #ffffff;">Open configuration file /etc/mail/dkim-milter/dkim-filter.conf and use the following configuration:</span></p>
<pre class="hljs"><code>Canonicalization simple
Domain example.com
KeyFile /some/path/<span class="hljs-keyword">to</span>/whatever-your-keyfile-was
<span class="hljs-keyword">Selector</span> name-<span class="hljs-keyword">of</span>-the-<span class="hljs-keyword">selector</span>
SignatureAlgorithm rsa-sha256
Socket inet:<span class="hljs-number">8891</span>@localhost
Syslog Yes
Userid dkim-milter</code></pre><p>NOTE: you will be configuring dkim-milter to use the loopback interface instead of a socket file. I was unable to get dkim-milter to work via the socket file with sendmail. If you get it working, let me know.</p>
<p>You may also want to setup the following:</p>
<pre class="hljs"><code><span class="hljs-title">SubDomains</span> Yes
SyslogSuccess Yes
X-Header Yes</code></pre><p><span style="background-color: #ffffff;">The X-Header and Syslog options are useful for debugging. See the config file, each option should be documented there.</span></p>
<p><strong>Step 9. Change the default init.d script to use the loopback interface</strong></p>
<h2 id="comments">Comments</h2>
<p><strong><a href="#64" title="2009-11-23 12:14:23">radu</a>:</strong> I&#39;ve used this:
Canonicalization simple
Domain mydomain.com
KeyFile /etc/dkim-milter/default
Selector mail
Signature default
SignatureAlgorithm rsa-sha256
Socket inet:8891@localhost
Syslog Yes
Userid dkim-milter
SubDomains Yes
SyslogSuccess Yes
X-Header Yes</p>
<p>but it says:
Starting DomainKeys Identified Mail Milter (dkim-filter): dkim-filter: /etc/mail/dkim-milter/dkim-filter.conf: configuration error at line 5: unrecognized parameter</p>
<p>The selector name is &quot;default&quot;.</p>
<p>Do you know what&#39;s wrong?</p>
<p><strong><a href="#65" title="2009-11-23 14:43:35">admin</a>:</strong> Hi, it&#39;s a mistake in my post, the &quot;Signature default&quot; part should not be there (there is no Signature parameter). Fixed this in the post.</p>
<p>So try removing that line.</p>
<p>See man dkim-filter.conf for the actual options.</p>
<p><strong><a href="#66" title="2009-11-24 06:02:56">radu</a>:</strong> Great, thanks.</p>
<p>Do you know how to setup this for multiple domains?</p>
<p><strong><a href="#68" title="2010-05-05 05:52:26">Vnmls</a>:</strong> Good tutorial, thanks!  Couple things I ran into:</p>
<ol>
<li>I had to put the INPUT_MAIL_FILTER into sendmail.mc, not submit.mc.  Sendmail was not communicating w/ dkim-milter at all until I did this.</li>
<li>I see no mention of ADSP.  Your readers can go here: <a href="http://www.sendmail.org/dkim/tools">http://www.sendmail.org/dkim/tools</a> to help set this up.</li>
</ol>
<p><strong><a href="#69" title="2010-09-18 19:15:13">Steve Jenkins</a>:</strong> Thanks for this write-up. I used OpenDKIM on my CentOS setup, and wrote about it <a href="http://stevejenkins.com/blog/2010/09/how-to-get-dkim-domainkeys-identified-mail-working-on-centos-5-5-and-postfix-using-opendkim/" rel="nofollow">here</a>.</p>
<p><strong><a href="#71" title="2012-05-26 16:44:25">Daisy Rosa</a>:</strong> I also had to move
INPUT_MAIL_FILTER
from  submit.mc to sendmail.mc</p>
<p><strong><a href="#72" title="2012-05-26 16:45:27">Daisy Rosa</a>:</strong> For multiple domains do:
REPLACE
Domain example.com
WITH
Domain example1.com, example2.com, example3.com</p>
<p><strong><a href="#73" title="2012-06-10 23:56:19">Kris</a>:</strong> Great doc, but it is missing the starting of dkim-milter.</p>
<p>So you have do add:</p>
<p>service dkim-milter start</p>
<p>after its install via yum.</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>