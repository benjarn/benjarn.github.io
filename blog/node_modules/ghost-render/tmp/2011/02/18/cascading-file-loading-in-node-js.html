<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Cascading file loading in Node.js</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Cascading file loading in Node.js">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Cascading file loading in Node.js">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2011/02/18/cascading-file-loading-in-node-js.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2011/02/18/cascading-file-loading-in-node-js.html" itemprop="url">Cascading file loading in Node.js</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2011-02-18" itemprop="datePublished">February 18, 2011</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>One of my favorite features of Kohana 3 is it&#39;s cascading filesystem - so I decided to implement it for Node.js. A cascading filesystem is an elegant solution to a common problem: how to provide a mechanism for loading modules and reusing code?</p>
<p>The following image from Kohana 3&#39;s docs shows an example:</p>
<p><a href="http://blog.mixu.net/files/2011/02/cascading_filesystem.png"><img title="cascading_filesystem" src="http://blog.mixu.net/files/2011/02/cascading_filesystem-223x300.png" alt="" width="223" height="300" /></a></p>
<h2>Benefits</h2>
The key benefits are:
<ol>
    <li><strong>Consistency</strong>. All your application files, including views, controllers, models and other data such as translation messages are loaded using one, easy-to-understand mechanism.</li>
    <li><strong>Easy reuse</strong>. Without a cascading file system, you&#39;ll have to copy and move files around if you want to use someone else&#39;s libraries or modules. With a cascading file system, you just place the module in your application, and enable cascading for that directory.</li>
    <li><strong>Transparent extensibility</strong>. What if you want to override one part of a module (say, a view) but don&#39;t want to modify your copy of the module (e.g. so that you can update without manually merging changes). A cascading filesystem allows you to selectively replace files in 3rd party code simply by providing your own version of the file.</li>
</ol>
<h2>The code</h2>
<ul>
    <li><a href="https://github.com/mixu/hmvc-cfs">https://github.com/mixu/hmvc-cfs</a>/</li>
    <li>It&#39;s only about 90 lines of code, see <a href="https://github.com/mixu/hmvc-cfs/blob/master/index.js">this file</a></li>
</ul>
<h2>Load order and file name resolution</h2>
The load order for my implementation is:
<ol>
    <li><strong>Application path</strong> -  files under ./application/ are always checked first.</li>
    <li><strong>Module paths</strong> - set modules([&#39;./modules/my-module&#39;]) to enable module loading. Files from modules are loaded from in the order they are added.</li>
    <li><strong>System path</strong> - files under ./system/ are loaded if no alternative exists.</li>
</ol>
<strong>Assumptions about file and class names</strong>

Files are assumed to be <strong><em>lowercase</em></strong>. <strong><em>Underscores in class names</em></strong> are replaced by slashes (so Controller_User becomes ./application/classes/ controller/user.js).

<strong>Performance impact</strong>

Requests are cached, so that additional calls to find_file() do not cause additional stat() calls in the filesystem. This is insignificant anyway, since Node.js servers are persistent so the cascading search is only done once per server instance for each file (not once per request).

<strong>Loading 3rd party code</strong>

The loaded files do not need to be &quot;compatible&quot; in any way other than layout in the file system. For example, while Cfs.factory(&#39;some_other_lib&#39;) loads the file from ./application/ classes/some/other/lib.js, that file does not actually need to contain a class named some_other_lib; just that it returns something via module.exports.
<h2>Methods</h2>
The methods are:
<ul>
    <li>Cfs.modules([&#39;./modules/path-to-module&#39;]) - set the modules directories to search.</li>
    <li>Cfs.find_file(dir, file, ext) - Search each path under dir (e.g. &#39;classes&#39;, &#39;views&#39;) for file (filename) with the extension (ext, default is &quot;.js&quot;).</li>
    <li>Cfs.factory(class_name) - Return a new instance of the given class after loading the corresponding file from the cascading file system. Note that classes should be in the classes subdirectory.</li>
    <li>Cfs.load(class_name) - Return whatever require(file-which-contains-the-class) returns. Useful for extending classes, see below for an example</li>
</ul>
<h2>Example usage:</h2>

<pre class="hljs"><code><span class="hljs-keyword">var</span> Cfs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#39;./cfs.js&#39;</span>);

<span class="hljs-comment">// test class loading:</span>
<span class="hljs-comment">// e.g. check ./application/classes/test.js</span>
<span class="hljs-comment">// ./modules/modulename/classes/test.js</span>
<span class="hljs-comment">// ./system/classes/test.js</span>
<span class="hljs-keyword">var</span> t = Cfs.factory(<span class="hljs-string">&#39;test&#39;</span>);
t.run();

<span class="hljs-comment">// test view loading</span>
<span class="hljs-comment">// e.g ./application/views/user/index.html</span>
<span class="hljs-comment">// ./modules/modulename/views/user/index.html</span>
<span class="hljs-comment">// ./system/views/user/index.html</span>
fs.readFile(Cfs.find_file(<span class="hljs-string">&#39;views&#39;</span>, <span class="hljs-string">&#39;user/index&#39;</span>, <span class="hljs-string">&#39;.html&#39;</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span> </span>{
  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
  sys.puts(data);
});</code></pre><p>To set modules:</p>
<pre class="hljs"><code>// <span class="hljs-operator"><span class="hljs-keyword">set</span> <span class="hljs-keyword">only</span> once, <span class="hljs-keyword">before</span> calling <span class="hljs-keyword">any</span> other functions!
Cfs.modules([
         <span class="hljs-string">&quot;./modules/testmodule/&quot;</span>,
         <span class="hljs-string">&quot;./modules/testmodule2/&quot;</span>,
         ]);</span></code></pre><h2>Extending classes:</h2>


<pre class="hljs"><code><span class="hljs-comment">// test extending class (see code in /application/classes/controller/extend.js</span>
<span class="hljs-comment">// to see how extension is achieved)</span>
<span class="hljs-comment">// e.g. ./application/classes/controller/extend.js</span>
<span class="hljs-comment">// ./modules/modulename/classes/controller/extend.js</span>
<span class="hljs-comment">// ./system/classes/controller/extend.js</span>
<span class="hljs-keyword">var</span> t3 = Cfs.<span class="hljs-literal">factory</span>(<span class="hljs-string">&#39;Controller_Extend&#39;</span>);
t3.run();
t3.run_parent();</code></pre><p>Note that if you put cfs.js in ~/node_modules/cfs.js, you don&#39;t need to specify the path to it... see Modules in node.js docs.</p>
<pre class="hljs"><code><span class="hljs-comment">// in extend.js:</span>
<span class="hljs-keyword">var</span> Controller<em>Extend = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
}
<span class="hljs-comment">// extend the class</span>
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#39;util&#39;</span>), Cfs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#39;../../../../cfs.js&#39;</span>);
util.inherits(Controller_Extend, Cfs.load(<span class="hljs-string">&#39;Controller_Base&#39;</span>));

Controller_Extend.prototype.run = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
   <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Controller_Extend from testmodule2.&quot;</span>);
};
Controller_Extend.prototype.run_parent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
   <span class="hljs-comment">// run the parent function</span>
   Controller_Extend.super</em>.prototype.run();
};

<span class="hljs-built_in">module</span>.exports = Controller_Extend;</code></pre><h2 id="comments">Comments</h2>
<p><strong><a href="#528" title="2012-03-02 00:17:07">shadowhand</a>:</strong> Calling this HMVC is highly misleading. The cascading filesystem has absolutely nothing to do with hierarchical model-view-controller. I strongly recommend that you rename your &quot;HMVC&quot; class to something reasonable, such as &quot;CFS&quot;.</p>
<p><strong><a href="#529" title="2012-03-02 07:51:27">Mikito Takada</a>:</strong> @shadowhand I agree and apologize if I have misled people. I had greater ambitions for the module at the time, hence the &quot;HMVC style&quot; reference, but I ended up doing other things.  I&#39;ve removed any references to HMVC here (well, except the diagram showing the cascading file system in Kohana but that&#39;s CFS rather than HMVC); I&#39;ll do github as well next time I actually work on that repo...</p>
<p>Edit: for clarification if someone ends up here: the title of this post used to be &quot;HMVC -style cascading...&quot;</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>