<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Implementing Facebook login (part 2)</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Implementing Facebook login (part 2)">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Implementing Facebook login (part 2)">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2011/01/03/implementing-facebook-login-part-2.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2011/01/03/implementing-facebook-login-part-2.html" itemprop="url">Implementing Facebook login (part 2)</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2011-01-03" itemprop="datePublished">January 03, 2011</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>In part 2 of my Facebook login tutorial, I will discuss implementing Facebook registration (see also: <a href="http://blog.mixu.net/2010/12/27/implementing-facebook-login-single-sign-on-part-1/">part 1</a> and <a href="http://blog.mixu.net/2011/01/09/implementing-facebook-login-part-3/">part 3</a>).</p>
<p>My design goals are to allow users to have either their own, separate account on the site or to link their account with Facebook. The design goals are:</p>
<p><ul>
    <li>User registration</p>
<p><ul>
    <li>Allow the user to register using Facebook and retrieve data from their profile to help fill in their information.</li>
    <li>Allow the user to register without using Facebook.</li>
    <li>Allow the user to add a Facebook profile later on to their account.</li>
    <li>Treat Facebook user ids just like email addresses: allow just one user account associated per Facebook user ID.</li>
</ul>
</li>
    <li>User login / authentication</p>
<p><ul>
    <li>Allow the user to sign in with just clicking a Sign in via Facebook button.</li>
    <li>Allow the user to sign in using their registered account name, if they have one.</li>
</ul>
</li>
</ul></p>
<p><h2>Registration flow</h2>
Facebook has recently (<a href="http://developers.facebook.com/blog/post/440">Dec 16th 2010</a>)  launched a registration tool for streamlining Facebook-based registration. We will be using it to implement the Facebook-enabled registration. However, since the dialog looks very &quot;facebooky&quot;, and some users will prefer not to have anything to do with Facebook, we will also offer our own registration form which looks more consistent with the site, but has no Facebook stuff in it.</p>
<p>The following diagram illustrates the registration flow with the Facebook alternative:</p>
<p><a href="http://blog.mixu.net/files/2010/12/flow2.png"><img class="alignnone size-full wp-image-1463" title="flow2" src="http://blog.mixu.net/files/2010/12/flow2.png" alt="" width="541" height="578" /></a></p>
<p>So basically, on the Login page, we will show a Facebook login link next to the regular login form, as well as normal registration link. If the user clicks the Facebook login link, then they will either be signed on via Facebook, or if they haven&#39;t signed up, they will be shown the Facebook enabled registration page. If the user clicks the regular registration link, they will be shown the non-Facebook registration page. Finally, the user can just login using their username and password on your site using the regular login form.</p>
<p><h2>Designing the Facebook-enabled registration page</h2>
If you already have a registration system on your site, you can leave that there. You then need to add the secondary, Facebook-enabled registration page.</p>
<p>The Facebook registration just needs to contain an iframe with the following content:</p>
<pre class="hljs"><code>&amp;lt;iframe <span class="hljs-variable">src=</span><span class="hljs-string">&quot;<a href="http://www.facebook.com/plugins/registration.php?">http://www.facebook.com/plugins/registration.php?</a>
             client_id=YOUR_APP_ID&amp;amp;
             redirect_uri=URLESCAPED_RETURN_PAGE
             fields=name,email&quot;</span>
        <span class="hljs-variable">scrolling=</span><span class="hljs-string">&quot;auto&quot;</span>
        <span class="hljs-variable">frameborder=</span><span class="hljs-string">&quot;no&quot;</span>
        <span class="hljs-variable">style=</span><span class="hljs-string">&quot;border:none&quot;</span>
        <span class="hljs-variable">allowTransparency=</span><span class="hljs-string">&quot;true&quot;</span>
        <span class="hljs-variable">width=</span><span class="hljs-string">&quot;100%&quot;</span>
        <span class="hljs-variable">height=</span><span class="hljs-string">&quot;310px&quot;</span>&amp;gt;
&amp;lt;/iframe&amp;gt;</code></pre><p>Check out the <a href="http://developers.facebook.com/docs/user_registration">Facebook documentation on what you can put in the fields</a>. The new registration tool can support custom fields. I will assume here that you just want their name and email.</p>
<p><h2>Receiving the data from the Facebook registration form</h2>
As you will notice from the Facebook documentation, the return value of the Facebook registration form is base64-encoded JSON, which includes an encoded (H)MAC (<a href="http://en.wikipedia.org/wiki/Message_authentication_code">message authentication code</a>) which is separated from the data itself by a single dot character.</p>
<p>First split the string, then decode the data (from Facebook&#39;s example code):</p>
<pre class="hljs"><code>&amp;lt;?php
  <span class="hljs-comment">// split to two variables based on the first dot character</span>
  <span class="hljs-keyword">list</span>(<span class="hljs-variable">$encoded_sig</span>, <span class="hljs-variable">$payload</span>) = explode(<span class="hljs-string">&#39;.&#39;</span>, <span class="hljs-variable">$signed_request</span>, <span class="hljs-number">2</span>);
  <span class="hljs-comment">// decode the data</span>
  <span class="hljs-variable">$sig</span> = base64_url_decode(<span class="hljs-variable">$encoded_sig</span>);
  <span class="hljs-variable">$data</span> = json_decode(base64_url_decode(<span class="hljs-variable">$payload</span>), <span class="hljs-keyword">true</span>);

  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#39;Hello &#39;</span>.<span class="hljs-variable">$data</span>[<span class="hljs-string">&#39;registration&#39;</span>][<span class="hljs-string">&#39;name&#39;</span>].<span class="hljs-string">&#39;!&#39;</span>;
  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#39;Your Facebook user ID is &#39;</span>.<span class="hljs-variable">$data</span>[<span class="hljs-string">&#39;user_id&#39;</span>].<span class="hljs-string">&#39;.&#39;</span>;</code></pre><p>You should also authenticate the return value using the secret key you received when you registered your website with Facebook. Otherwise, someone could fake a registration request and cause problems with user login. You can do it like this:</p>
<pre class="hljs"><code><span class="hljs-subst">&amp;</span><span class="hljs-literal">lt</span>;<span class="hljs-subst">?</span>php
  <span class="hljs-comment">// check the signature in $sig using $payload</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$sig</span> <span class="hljs-subst">!==</span> hash_hmac(<span class="hljs-string">&#39;sha256&#39;</span>, <span class="hljs-variable">$payload</span>, FACEBOOK_SECRET, <span class="hljs-literal">TRUE</span>)) {
    <span class="hljs-comment">// INVALID SIGNATURE! Show an error message.</span>
  }</code></pre><p><h2>Saving the data into an existing user account system</h2>
There are number of things you want to take into account when saving the from the user data into the system:</p>
<p><ul>
    <li>Facebook does not give you a username for the user unless you ask for one. You can either:</p>
<p><ul>
    <li>Ask for one from the user as a custom field (easy, but I don&#39;t like it since it reduces the convenience of Facebook integration; and what about if that username is taken?).</li>
    <li>Make it so that you can have user accounts that do not have a username at all.</li>
    <li>In both cases, you have to make sure that the user cannot log in directly using the old style login, only via Facebook (unless you ask for a password as well).</li>
</ul>
</li>
    <li>The user might have already registered an account on your site with the same email address. In this case, you don&#39;t want to duplicate the user, and usually you can&#39;t since email addresses are expected to be unique across the system.</li>
    <li>You need to make database changes to add two pieces of information: first, the user&#39;s Facebook user id and second, the time-limited access token we need to retrieve more data from Facebook (oauth_token in the return value).</li>
</ul>
Since these are specific to your application, I can&#39;t say much about them. In any case, you want to add facebook_user_id as one field in the user information.</p>
<p><strong>Option 1</strong> would be to set the user name to empty for those users registered from Facebook. You then need to design your application so that it can show the full name of the user instead of the username elsewhere, since this field will now not necessarily be filled in. A properly designed app should not need to search for users by their username, but rather by user ID on your site. You also need to make sure that users with empty usernames/passwords cannot log in.</p>
<p><strong>Option 2</strong> would be to auto-generate a user id for the user based on their name. You need to make sure the username is not taken, and if it is, generate an alternative. Then you can allow the user to change their username later, as long as uniqueness checks are maintained. You need to make sure that users without a password cannot log in, or generate a really long random string as the password, hash it and forget the password completely.</p>
<p><strong>Option 3</strong> would be to ask for a username, and perhaps even a password - but then the only benefit is that you get some information typed in automatically, which does not make for a smooth experience (weren&#39;t we trying to avoid filling in fields here?).</p>
<p>I would go with option 2. While it does theoretically open the possibility that someone could guess the random string and autogenerated user id; I think there are easier avenues of attack such as guessing weak passwords.</p>
<p><h2>Next part</h2>
<a href="http://blog.mixu.net/2011/01/09/implementing-facebook-login-part-3/">In part 3 of my Facebook login tutorial</a> I go into implementation specifics using the Javascript SDK.</p>
<h2 id="comments">Comments</h2>
<p><strong><a href="#287" title="2011-03-01 13:26:13">Kabindra Bakey</a>:</strong> just the thing i need... its better with the logout system flowchart embeded too</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>