<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Nginx, php-fpm and node.js install on Centos 5.5</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Nginx, php-fpm and node.js install on Centos 5.5">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Nginx, php-fpm and node.js install on Centos 5.5">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2011/01/04/nginx-php-fpm-and-node-js-install-on-centos-5-5.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2011/01/04/nginx-php-fpm-and-node-js-install-on-centos-5-5.html" itemprop="url">Nginx, php-fpm and node.js install on Centos 5.5</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2011-01-04" itemprop="datePublished">January 04, 2011</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>After some time with node.js I recently decided to move to nginx + php-fpm + node.js for my future servers. Here we will be installing:</p>
<ul>
    <li>Nginx as a fast HTTP server with reverse proxy to node.js</li>
    <li>php-fpm for running PHP scripts. The php-fpm (PHP FastCGI sapi) is built into the PHP core but only since 5.3.3, so we need a recent version of PHP.</li>
    <li>node.js for handling comet and high-concurrency/persistent connections.</li>
    <li>Monit is used to restart node.js in case of errors.</li>
</ul>

<p>For all the packages other than node.js (obviously, since it&#39;s new/actively changing), you can get the most recent version without to patching/compiling anything anymore.</p>
<p>Start by updating your packages and uninstalling httpd if you had it installed:</p>
<pre class="hljs"><code><span class="hljs-title">yum</span> update</code></pre><pre class="hljs"><code><span class="hljs-title">yum</span> remove httpd</code></pre><h2>Add repositories for nginx and PHP-fpm</h2>
Just add the EPEL and Remi repos:

<code>bash
rpm -Uvh http://download.fedora.redhat.com/pub/epel/5/i386/epel-release-5-4.noarch.rpm
rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-5.rpm</code>

<h2>Install nginx and PHP-fpm</h2>

<p>Remi has the php-fpm package (php 5.3.4); EPEL has nginx:</p>
<pre class="hljs"><code>yum <span class="hljs-comment">--enablerepo=remi install php-fpm nginx</span></code></pre><p>Some other common packages:</p>
<pre class="hljs"><code>yum --enablerepo=remi install mysql mysql-<span class="hljs-keyword">server</span> php-mysql php-<span class="hljs-keyword">common</span> php-gd php-mbstring php-mcrypt php-xml php-gd php-bcmath</code></pre><p>PHPunit and PHPdocumentor:</p>
<pre class="hljs"><code>yum <span class="hljs-comment">--enablerepo=remi install php-channel-phpunit php-pear-PhpDocumentor php-phpunit-PHPUnit</span></code></pre><h2>Create a test application</h2>

<pre class="hljs"><code>mkdir /<span class="hljs-keyword">var</span>/www/</code></pre><p>In /var/www/index.php:</p>
<pre class="hljs"><code>&amp;lt;?<span class="hljs-function">php
  <span class="hljs-title">phpinfo</span><span class="hljs-params">()</span></span>;</code></pre><h2>Configure nginx</h2>

<p>In /etc/nginx/nginx.conf:</p>
<pre class="hljs"><code><span class="hljs-title">server</span> {
   <span class="hljs-title">listen</span>       <span class="hljs-number">80</span>;
   <span class="hljs-title">server<em>name</span>  </em>;
   <span class="hljs-title">access_log</span>  logs/host.access.log  main;
   <span class="hljs-title">root</span>   /var/www;
   <span class="hljs-title">index</span>  index.php index.html index.htm;
   <span class="hljs-title">location</span> <span class="hljs-regexp">~ .php$</span> {
      <span class="hljs-comment"># Security: must set cgi.fixpathinfo to 0 in php.ini!</span>
      <span class="hljs-title">fastcgi_split_path_info</span><span class="hljs-regexp"> ^(.+.php)(/.+)$</span>;
      <span class="hljs-title">fastcgi_pass</span> <span class="hljs-number">127.0.0.1:9000</span>;
      <span class="hljs-title">fastcgi_index</span> index.php;
      <span class="hljs-title">fastcgi_param</span> SCRIPT_FILENAME          <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;
      <span class="hljs-title">fastcgi_param</span> PATH_INFO <span class="hljs-variable">$fastcgi_path_info</span>;
      <span class="hljs-title">include</span> /etc/nginx/fastcgi_params;
   }
}</code></pre><p><strong>Default fastcgi_params</strong></p>
<p>I start the php location by including /etc/nginx/fastcgi_params. This is because I want to use those as defaults, then override them individually afterwards. It is also recommended to have one root directive per server.</p>
<p><strong>PHP path</strong></p>
<p>I  use fastcgi_split_path_info which became available in 0.7.31 to pass PATH_INFO.</p>
<p><strong>Security settings</strong></p>
<p>IMPORTANT: Change cgi.fix_pathinfo to 0 in php.ini to prevent a <a href="http://cnedelcu.blogspot.com/2010/05/nginx-php-via-fastcgi-important.html">security issue</a> which arises with the default PHP configuration when PHP incorrectly tries to guess which file you want for URLS specifying nonexistent files. Setting cgi.fix_pathinfo=0 causes PHP to only try the literal path given. Alternatively check that the file exists: if (!-f $request_filename) { return 404; }</p>
<p>See also: <a href="http://wiki.nginx.org/Pitfalls">Nginx pitfalls</a>.</p>
<h2>Start/restart and test</h2>

<pre class="hljs"><code><span class="hljs-title">service</span> php-fpm start</code></pre><pre class="hljs"><code><span class="hljs-title">service</span> nginx restart</code></pre><p>Test by going to your server root, it should show you your phpinfo().</p>
<h2>Prepare to install node.js</h2>
Excellent post: <a href="http://wavded.tumblr.com/post/475957278/hosting-nodejs-apps-on-centos-5">http://wavded.tumblr.com/post/475957278/hosting-nodejs-apps-on-centos-5</a>

Add a user for node.js:

<code>bash
groupadd -r node
useradd -r --shell /bin/bash --comment &#39;User for running node.js&#39; -g node  --home /var/lib/node node</code>

I prefer using /var/lib/node rather than /home/node because this is more in line with how other server daemon users are defined (e.g. nginx, mysql). -r is for --system, --comment is for --gecos.

<h2>Install node.js</h2>

<pre class="hljs"><code>yum install gcc-<span class="hljs-keyword">c</span>++ openssl-devel
wget --<span class="hljs-keyword">no</span>-check-certificate http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/ry/node/tarball/v0.<span class="hljs-number">3.3</span>
tar -xzvf ry-node-v0.<span class="hljs-number">3.3</span>-<span class="hljs-number">0</span>-g57544ba.tar.gz
<span class="hljs-keyword">cd</span> ry-node-v0.<span class="hljs-number">3.3</span>-<span class="hljs-number">0</span>-g57544bac1
./configure
<span class="hljs-keyword">make</span>
<span class="hljs-keyword">make</span> install
<span class="hljs-built_in">mkdir</span> /var/node</code></pre><h2>Create a test application</h2>

<p>For node.js apps, I prefer to keep the www and node trees separate. Also note that I am running unstable 0.3.3 not 0.2.x, so the example is slightly different. Create the example file /var/node/hello_world/example.js:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> sys = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;sys&quot;</span>),
   http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>);
http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(request, response)</span> </span>{
  response.writeHead(<span class="hljs-number">200</span>, {<span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;text/plain&quot;</span>});
  response.end(<span class="hljs-string">&quot;Hello Worldn&quot;</span>);
}).listen(<span class="hljs-number">8000</span>);
sys.puts(<span class="hljs-string">&quot;Server running at 127.0.0.1:8000&quot;</span>);</code></pre><h2>Configure nginx for node.js (subdirectory approach)</h2>
In /etc/nginx/nginx.conf (after the server definition has started):

<code>bash
location /node {
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   proxy_set_header Host $http_host;
   proxy_set_header X-NginX-Proxy true;
   proxy_pass http://127.0.0.1:8000/;
   proxy_redirect off;
}</code>

</div>
<h2>Install monit</h2>

<pre class="hljs"><code><span class="hljs-title">yum</span> install monit</code></pre><h2>Create monit script</h2>
/etc/monit.d/hello_world content:

<code>bash
check host hello_world with address 127.0.0.1
    start program = &quot;/usr/local/bin/node /var/node/hello_world/example.js&quot; as uid node and gid node
    stop program  = &quot;/usr/bin/pkill -f &#39;node /var/node/hello_world/example.js&#39;&quot;
    if failed port 8000 protocol HTTP
        request /
        with timeout 10 seconds
        then restart</code>

<h2>Start/restart and test</h2>

<pre class="hljs"><code><span class="hljs-title">service</span> monit start</code></pre><pre class="hljs"><code><span class="hljs-title">service</span> nginx restart</code></pre><p>Test by going to /node on your server.</p>
<p>Also, run ps -Af to verify that node is running with the uid node.</p>
<h2>The reboot test</h2>

<p>Finally, test everything by restarting your server. A friendly reminder:</p>
<pre class="hljs"><code>chkconfig nginx <span class="hljs-command"><span class="hljs-keyword">on</span></span>

chkconfig monit <span class="hljs-command"><span class="hljs-keyword">on</span></span>

chkconfig php-fpm <span class="hljs-command"><span class="hljs-keyword">on</span></span>

chkconfig mysqld <span class="hljs-command"><span class="hljs-keyword">on</span></span>

chkconfig <span class="hljs-comment">--list</span></code></pre><h2 id="comments">Comments</h2>
<p><strong><a href="#413" title="2011-07-16 17:03:08">Andy</a>:</strong> Great write up, still works on CentOS 6. Thanks!</p>
<p><strong><a href="#414" title="2011-07-25 18:41:07">Chris Abernethy</a>:</strong> Agreed, this is a great writeup on a good alternative to the standard apache stack.</p>
<p>If you&#39;re interested in also managing node.js with RPM, check out my post on that here: <a href="http://www.chrisabernethy.com/installing-node-js-on-centos-redhat/">http://www.chrisabernethy.com/installing-node-js-on-centos-redhat/</a></p>
<p><strong><a href="#415" title="2011-10-13 19:31:45">dim</a>:</strong> Hi, thx for this post, i am trying to do something similar on ubuntu, and he question i have is:</p>
<p>Does your setup works with simple websocket server written in nodejs (with socket io for example).</p>
<p>And 2nd question: what version of nginx do you use?</p>
<p>@ref  <a href="https://github.com/LearnBoost/socket.io/wiki/Nginx-and-Socket.io">https://github.com/LearnBoost/socket.io/wiki/Nginx-and-Socket.io</a></p>
<p>thanks !</p>
<p><strong><a href="#417" title="2012-03-14 05:59:54">nico</a>:</strong> Hi... recently i read this, mmm... it&#39;s really faster than previous configuration?</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>