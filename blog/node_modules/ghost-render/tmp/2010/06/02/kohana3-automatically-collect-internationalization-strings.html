<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Kohana3: automatically collect internationalization strings</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Kohana3: automatically collect internationalization strings">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Kohana3: automatically collect internationalization strings">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/06/02/kohana3-automatically-collect-internationalization-strings.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/06/02/kohana3-automatically-collect-internationalization-strings.html" itemprop="url">Kohana3: automatically collect internationalization strings</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-06-02" itemprop="datePublished">June 02, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>I started implementing i18n for my upcoming KO3 application, and implemented a quick patch so that I don&#39;t need to manually find and type translation strings.</p>
<p><strong>What this code does</strong></p>
<p>What the code below does is it checks whether the translation string exists, if not then it saves it into the translation file with the English equivalent. This updated version of the translation string file is saved into /application/i18n/languagename.php, and the old file is saved with a new name containing the current date and time.</p>
<p>Hope this helps!</p>
<p><strong>How to set it up</strong></p>
<p>First set the language using i18n::lang(&#39;xy-xx&#39;) in bootstrap.php.</p>
<p>Also, add the following as the last line in bootstrap.php:</p>
<p><pre lang="php">// Write the updated language file, if necessary
i18n::write();</pre>
Finally, add the file <strong>/application/classes/i18n.php</strong> which overrides i18n::get():</p>
<pre class="hljs"><code><span class="hljs-comment">/<strong>
 <em> A patch for the Internationalization (i18n) class.
 </em>
 <em><span class="hljs-phpdoc"> @package</span>    I18n
 </em><span class="hljs-phpdoc"> @author</span> Mikito Takada
 */</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">I18n</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Kohana_I18n</span> </span>{
    <span class="hljs-comment">// Cache of missing strings</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-variable">$_cache_missing</span> = <span class="hljs-keyword">array</span>();

    <span class="hljs-comment">/</strong>
     <em> Returns translation of a string. If no translation exists, the original
     </em> string will be returned. No parameters are replaced.
     <em>
     </em>     $hello = I18n::get(&#39;Hello friends, my name is :name&#39;);
     <em>
     </em><span class="hljs-phpdoc"> @param</span>   string   text to translate
     <em><span class="hljs-phpdoc"> @param</span>   string   target language
     </em><span class="hljs-phpdoc"> @return</span>  string
     <em>/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-variable">$string</span>, <span class="hljs-variable">$lang</span> = NULL)</span>
    </span>{
        <span class="hljs-keyword">if</span> ( ! <span class="hljs-variable">$lang</span>)
        {
            <span class="hljs-comment">// Use the global target language</span>
            <span class="hljs-variable">$lang</span> = I18n::<span class="hljs-variable">$lang</span>;
        }

        <span class="hljs-comment">// Load the translation table for this language</span>
        <span class="hljs-variable">$table</span> = I18n::load(<span class="hljs-variable">$lang</span>);

        <span class="hljs-comment">// Return the translated string if it exists</span>
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$table</span>[<span class="hljs-variable">$string</span>]))
      {
         <span class="hljs-keyword">return</span> <span class="hljs-variable">$table</span>[<span class="hljs-variable">$string</span>];
      } <span class="hljs-keyword">else</span> {
         <span class="hljs-comment">// Translated string does not exist</span>
         <span class="hljs-comment">// Store the original string as missing - still makes sense to store the English string so that loading the untranslated file will work.</span>
         I18n::<span class="hljs-variable">$_cache_missing</span>[<span class="hljs-variable">$lang</span>][<span class="hljs-variable">$string</span>] = <span class="hljs-variable">$string</span>;
         <span class="hljs-keyword">return</span> <span class="hljs-variable">$string</span>;
      }
    }

   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span><span class="hljs-params">()</span>
   </span>{
      <span class="hljs-comment">// something new must be added for anything to happen</span>
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(I18n::<span class="hljs-variable">$_cache_missing</span>)) {
         <span class="hljs-variable">$contents</span> = <span class="hljs-string">&#39;&amp;lt;?php defined(&#39;</span>SYSPATH<span class="hljs-string">&#39;) or die(&#39;</span>No direct script access.<span class="hljs-string">&#39;);
/**
 </em> Translation file in language: &#39;</span>.I18n::<span class="hljs-variable">$lang</span>.<span class="hljs-string">&#39;
 <em> Automatically generated from previous translation file.
 </em>/
return &#39;</span>.var<em>export(array_merge(I18n::<span class="hljs-variable">$_cache_missing</span>[I18n::<span class="hljs-variable">$lang</span>], I18n::<span class="hljs-variable">$_cache</span>[I18n::<span class="hljs-variable">$lang</span>]), <span class="hljs-keyword">true</span>).<span class="hljs-string">&#39;;&#39;</span>;

         <span class="hljs-comment">// save string to file</span>
         <span class="hljs-variable">$savepath</span> = APPPATH.<span class="hljs-string">&#39;/i18n/&#39;</span>;
         <span class="hljs-variable">$filename</span> = I18n::<span class="hljs-variable">$lang</span>.<span class="hljs-string">&#39;.php&#39;</span>;
         <span class="hljs-comment">// check that the path exists</span>
         <span class="hljs-keyword">if</span>(!file_exists(<span class="hljs-variable">$savepath</span>)) {
            <span class="hljs-comment">// if not, create directory</span>
            mkdir(<span class="hljs-variable">$savepath</span>, <span class="hljs-number">0777</span>, <span class="hljs-keyword">true</span>);
         }
         <span class="hljs-comment">// rename the old file - if the file size is different.</span>
         <span class="hljs-keyword">if</span>(file_exists(<span class="hljs-variable">$savepath</span>.<span class="hljs-variable">$filename</span>) &amp;amp;&amp;amp; ( filesize(<span class="hljs-variable">$savepath</span>.<span class="hljs-variable">$filename</span>) != strlen(<span class="hljs-variable">$contents</span>) ) ) {
            <span class="hljs-variable">$result</span> = rename(<span class="hljs-variable">$savepath</span>.<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$savepath</span>.I18n::<span class="hljs-variable">$lang</span>.<span class="hljs-string">&#39;</em>&#39;</span>.date(<span class="hljs-string">&#39;Y_m_d_H_i_s&#39;</span>).<span class="hljs-string">&#39;.php&#39;</span>);
            <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$result</span>) {
               <span class="hljs-comment">// Rename failed! Don&#39;t write the file.</span>
               <span class="hljs-keyword">return</span>;
            }
         }
         <span class="hljs-comment">// save the file</span>
         file_put_contents(<span class="hljs-variable">$savepath</span>.<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$contents</span>);
      }
   }
}</code></pre><p><strong>Caveats and notes</strong></p>
<p>There are two things that have to be taken into account:</p>
<ul>
    <li>First, this is would obviously be inefficient for a production site, since actual files are being rewritten on each request that finds new translation strings.</li>
    <li>Why this is not a problem: My recommendation is that you shouldn&#39;t run this code in production mode, since there is no point and it is very easy to remove the code after developement is completed.</li>
    <li>Second, this approach is less comprehensive than using something like the gettext tools that are available - those tools scan all of the source code, while my approach depends on run-time detection of new strings. This means that a small percentage of strings will not be found automatically (ex. rare errors that never get triggered).</li>
    <li>Why this is not a problem: This approach will still get the vast majority of the strings without requiring any manual hunting for strings, so I think it&#39;ll save you quite a bit of time.</li>
</ul>

<h2 id="comments">Comments</h2>
<p><strong><a href="#224" title="2010-12-10 04:34:48">Beto</a>:</strong> Hello,</p>
<p>I took the liberty to organize their class within a module, so I believe that is easier to reuse.</p>
<p>Of course, I kept developing the credits, I made only a small modification that I found interesting to make it more readable.</p>
<p>On my blog (Brazilian Portuguese) I wrote a bit more of a module called i18n-files.</p>
<p><a href="http://beto.euqueroserummacaco.com/blog/kohana-modulo-i18n-files-traduzinho-seu-software-de-maneira-simples/">http://beto.euqueroserummacaco.com/blog/kohana-modulo-i18n-files-traduzinho-seu-software-de-maneira-simples/</a></p>
<p>I hope this does not leave angry.</p>
<p><strong><a href="#225" title="2010-12-10 12:38:20">Mikito Takada</a>:</strong> Hi Beto,</p>
<p>Good to hear that you found it useful, thanks for your blog post! I had a look at it via Google Translate...</p>
<p><strong><a href="#226" title="2011-05-20 16:45:08">Beto</a>:</strong> Hello Mikito,</p>
<p>After all this time returned to his post to clarify some doubts. Your article is very good!</p>
<p>About the google translator .... he is really good is not it? Always saves me when I do not understand the text written in other languages.</p>
<p><strong><a href="#227" title="2011-10-29 15:45:00">Ando</a>:</strong> Hey,</p>
<p>I can&#39;t seem to overload the Kohana i18n class, specifically.</p>
<p>Kohana seems to load the system&#39;s i18n and leave my classes/i18n.php untouced.</p>
<p>The filenames/ locations / class i18n extends Kohana_I18n all seem ok.</p>
<p>When manually require-ing the file:
PHP Fatal error:  Cannot redeclare class I18n in  ...</p>
<p>Any ideas?</p>
<p><strong><a href="#229" title="2012-01-31 12:55:04">Nuno</a>:</strong> nice man. thanks</p>
<p><strong><a href="#574" title="2012-08-09 15:04:33">jaydublu</a>:</strong> I found that just adding I18n::write() into bootstrap.php didn&#39;t work - it was run before any new strings were collected.</p>
<p>But, looking at Beto&#39;s module I spotted that register_shutdown_function(array(&#39;I18n&#39;, &#39;write&#39;));
 is a way that will work.</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>