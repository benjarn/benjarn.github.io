<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Step-by-step guide to Kohana 3 auth</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Step-by-step guide to Kohana 3 auth">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Step-by-step guide to Kohana 3 auth">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/09/06/step-by-step-guide-to-kohana-3-auth.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/09/06/step-by-step-guide-to-kohana-3-auth.html" itemprop="url">Step-by-step guide to Kohana 3 auth</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-09-06" itemprop="datePublished">September 06, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>The Kohana 3 Auth model implements a set of basic functionality for authentication (login) and authorization (user rights based on roles). In this series of posts, I will discuss:</p>
<p><ol>
    <li>Setting up the basic Auth in KO3 (part 1; this part)</li>
    <li><a href="http://blog.mixu.net/2010/09/07/kohana-3-auth-the-auth-module-functionality/">An overview of the functionality provided by the Auth module</a> (part 2)</li>
    <li><a href="http://blog.mixu.net/2010/09/14/kohana-3-auth-sample-implementation-and-documentation/">Tips on implementing Auth in a custom application</a> (part 3)</li>
</ol>
This first post in the series I will discuss setting up KO3 Auth.</p>
<p><span style="text-decoration: underline;">UPDATED March 2011: now covers the steps for Kohana 3.1</span></p>
<p><strong>1. Enable the Auth module in Kohana3</strong></p>
<p>Open application/bootstrap.php and uncomment the auth, database and orm modules:</p>
<pre class="hljs"><code>Kohana<span class="hljs-tag">::modules</span>(<span class="hljs-built_in">array</span>(
     <span class="hljs-string">&#39;auth&#39;</span>       <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; MODPATH<span class="hljs-built_in">.<span class="hljs-variable">&#39;auth&#39;</span></span>,       <span class="hljs-comment">// Basic authentication</span>
    <span class="hljs-string">&#39;database&#39;</span>   <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; MODPATH<span class="hljs-built_in">.<span class="hljs-variable">&#39;database&#39;</span></span>,   <span class="hljs-comment">// Database access</span>
    <span class="hljs-string">&#39;orm&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; MODPATH<span class="hljs-built_in">.<span class="hljs-variable">&#39;orm&#39;</span></span>,        <span class="hljs-comment">// Object Relationship Mapping</span>
    ));</code></pre><p>You don&#39;t have to use ORM with Auth (the default driver is &quot;file&quot;), but many people do.</p>
<p><strong>2. If you haven&#39;t done it earlier, setup the database</strong></p>
<p>Copy modules/database/config/database.php to application/config/. Set the username, password, database and host on in the file.</p>
<p><strong>3. Create the database tables</strong></p>
<p>You can find <a href="http://docs.kohanaphp.com/addons/auth#mysql_schema">the database schema on the Kohana wiki</a> or from modules/orm/auth-schema-mysql.sql.</p>
<p>Note that the password column should be CHAR(64) for sha256.</p>
<p><strong>4. Configure the hash_key for Kohana 3.1.x</strong></p>
<p>Copy modules/auth/config/auth.php to application/config/. This will override the default settings.</p>
<p>In Kohana 3.1, the default hash method is now sha256 instead of sha1. This means that there is no salt_pattern; and that old KO 3.x passwords are not compatible with KO 3.1! See <a href="http://dev.kohanaframework.org/issues/3163">the discussion on this bug for more information</a>. TL;DR: the salt pattern is weak, so if someone steals your database but does not know your salt_key, they can deduce it easily and perform a dictionary attack.</p>
<p>Instead, you need to configure your hash_key which gets passed to <a href="http://php.net/manual/en/function.hash-hmac.php">http://php.net/manual/en/function.hash-hmac.php</a>. You can also use any of the hast_hmac() supported algorithms if you want to.</p>
<p>Use a random hash_key, for example from: <a href="https://www.grc.com/passwords.htm">https://www.grc.com/passwords.htm</a></p>
<p><span style="font-family: Consolas, Monaco, 'Courier New', Courier, monospace; font-size: 12px; line-height: 18px; white-space: pre;"> return array</span></p>
<pre class="hljs"><code>(
    <span class="hljs-string">&#39;driver&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;ORM&#39;</span>,
    <span class="hljs-string">&#39;hash_method&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;sha256&#39;</span>,
    <span class="hljs-string">&#39;hash_key&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">NULL</span>, <span class="hljs-comment">// replace with random string</span>
    <span class="hljs-string">&#39;lifetime&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-number">1209600</span>,
    <span class="hljs-string">&#39;session_key&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;auth_user&#39;</span>,
    <span class="hljs-string">&#39;users&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(),
);</code></pre><p><strong>5. Next steps: implement login, logout, user role checking and so on...</strong></p>
<p>Now you have enabled the basic auth functionality. Next you have to actually perform the checks for whether the user is logged in and whether they have the correct rights. You will also want to implement functionality for the user to log in and log out as well as to view/edit/delete their profile, change/reset their password and for administrative functionality.</p>
<p>I have provided my own implementation for this functionality, which I will look into in part 3 of this series. You can download the implementation and use it as a basis of your work - please leave a comment and send improvements back if possible.</p>
<p>If you want to implement the functionality yourself, I have discussed the main functionality provided by Auth in part 2 of this series.</p>
<p><strong>Other Kohana Auth tutorials (NOTE Kohana 3.x):</strong></p>
<ul>
    <li><a href="http://www.nanodocumet.com/?p=26">Kohana 3: AUTH, A2 &amp; ACL</a> (nanodocumet.com)</li>
    <li><a href="http://kohanaes.com.ar/?p=3">Spanish (?) tutorial on Auth</a></li>
</ul>

<h2 id="comments">Comments</h2>
<p><strong><a href="#93" title="2011-03-16 20:50:01">Christher</a>:</strong> Nice. But what have happend to the Auth module?
There is now ORM or salt_pattern?</p>
<p><strong><a href="#94" title="2011-05-12 19:08:59">Andrzej Ośmiałowski</a>:</strong> It&#39;s now part of the ORM. Check it our: /ORM/classes/kohana/auth/orm.php.</p>
<p>@author - Depending on your needs, you should consider using sha512 instead of sha256.</p>
<p><strong><a href="#95" title="2011-07-29 13:33:55">Ilyas Kazi</a>:</strong> Have u checked with Kohana 3.2 framework. It&#39;s seem to be quite different from what you are explaining here..</p>
<p>Do u hv any plan for kohana 3.2 authentication example ?</p>
<p><strong><a href="#96" title="2011-08-25 22:39:05">jturo</a>:</strong> Well the post is based on 3.1, i, have you tried installing the 3.2 if so what was your experience like? from what i understand this is pretty much the same, the hash method is using a hash_hmac concatenating the string with the hash_key using the hash method defined in the configuration file.</p>
<p><strong><a href="#97" title="2011-08-25 22:40:12">jturo</a>:</strong> @lyas Kazi: Well the post is based on 3.1, i, have you tried installing the 3.2 if so what was your experience like? from what i understand this is pretty much the same, the hash method is using a hash_hmac concatenating the string with the hash_key using the hash method defined in the configuration file.</p>
<p><strong><a href="#98" title="2011-09-12 11:23:37">Arte</a>:</strong> And what if you want to rename your user table into something different? instead of users, you want to have &quot;admins&quot;?</p>
<p><strong><a href="#99" title="2011-12-22 18:16:12">Pad</a>:</strong> Nice series of tuto.</p>
<p>I will use this as a basis to my learning of Kohana, i appreciate your work and how you present it.</p>
<p>Thanks, i&#39;ll put a link when my website will be on back to your work. I&#39;ll tell you when it comes..</p>
<p>See ya.</p>
<p><strong><a href="#100" title="2012-01-06 22:12:31">William Murray</a>:</strong> I&#39;m using Kohana 3.2 and setting up the Auth module using ORM. I was having trouble with the login and found that the Auth SQL on the wiki (linked to from this page) is setting the password field in the user table to have a length of 50. However, the sha256 hashed password will generate a 64 character string. The Auth SQL needs to be fixed to set the password field length to 64 characters.</p>
<p><strong><a href="#101" title="2012-01-06 22:13:48">William Murray</a>:</strong> Sorry, I just noticed that step 3 says to change the password to char(64). Ignore my previous post.</p>
<p><strong><a href="#103" title="2012-01-30 23:59:52">Antoine Lépée</a>:</strong> Ok ! You just saved me a lot time with your comments :)</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>