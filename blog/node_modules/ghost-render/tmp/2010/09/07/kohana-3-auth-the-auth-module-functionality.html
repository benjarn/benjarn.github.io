<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Kohana 3 auth: the auth module functionality</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Kohana 3 auth: the auth module functionality">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Kohana 3 auth: the auth module functionality">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/09/07/kohana-3-auth-the-auth-module-functionality.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/09/07/kohana-3-auth-the-auth-module-functionality.html" itemprop="url">Kohana 3 auth: the auth module functionality</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-09-07" itemprop="datePublished">September 07, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>The Kohana 3 Auth model implements a set of basic functionality for authentication (login) and authorization (user rights based on roles). In this series of posts, I will discuss:</p>
<p><ol>
    <li><a href="http://blog.mixu.net/2010/09/06/step-by-step-guide-to-kohana-3-auth/">Setting up the basic Auth in KO3</a> (part 1)</li>
    <li>An overview of the functionality provided by the Auth module (part 2; this part)</li>
    <li><a href="http://blog.mixu.net/2010/09/14/kohana-3-auth-sample-implementation-and-documentation/">Tips on implementing Auth in a custom application</a> (part 3)</li>
</ol>
In this second post in the series I will discuss the different functionality provided by the Auth module.</p>
<p><strong>An overview of the files in the KO3 Auth module:</strong></p>
<p><ul>
    <li>modules/auth/classes/kohana/auth/file.php - contains the file driver for Auth.</li>
    <li>modules/auth/classes/kohana/auth/orm.php - contains the ORM driver for Auth.</li>
    <li>modules/auth/classes/kohana/auth.php - implements the Auth singleton.</li>
    <li>modules/auth/classes/model/auth/user.php - User model (Model_Auth_User).</li>
    <li>modules/auth/classes/model/auth/role.php - Role model (Model_Auth_Role).</li>
    <li>modules/auth/classes/model/auth/user/token.php - User_token model (Model_Auth_User_Token).</li>
    <li>modules/auth/config/auth.php - Auth module configuration.</li>
</ul>
<strong>Different drivers: File and ORM</strong></p>
<p>There are two different drivers for Auth. The ORM driver is most commonly used, and it stores and retrieves data in the database. The File driver is the alternative, which stores credentials in the auth module config file.</p>
<p><strong> ORM functionality vs. Auth functionality</strong></p>
<p>It is important to note that the Auth class models (user, role, token) extend the ORM base class. This means that all the ORM methods can be used e.g. to retrieve users using different conditions in the same way as other ORM models would.</p>
<p>Have a look at the ORM documentation for specifics.  The Auth functionality for the ORM driver is built upon the ORM, and it uses the existing functionality such as relationships ($_has_many), validation rules ($_rules, $_ignored_columns), callbacks ($_callbacks).</p>
<p>Much of what you will be doing with the users model will be adding extended information such as new relationships and new fields. As long as you keep the default relationships, rules and field names, you will be able to flexibly extend the user model to suit your needs.</p>
<p><strong>The Auth singleton</strong></p>
<p>Auth class (/modules/auth/classes/kohana/auth/orm.php):</p>
<p><ul>
    <li>Auth::instance(). Retrieves the instance of the Auth singleton.</li>
    <li>logged_in($role = NULL). If called without arguments, checks whether the user is logged in. If an argument is given, then checks whether the logged in  user has the given role (string/Role object) or roles (array of strings / Role objects).</li>
    <li>get_user(). Retrieves the user model for the user who is currently logged in (or FALSE).</li>
    <li>login(array &amp; $array, $redirect = FALSE). The array should contain the password and username. If the redirect parameter is set, then the login will be redirected to the given URL.</li>
    <li>logout(). Logs the current user out.</li>
    <li>force_login($username). Forces the username given as the first argument to log in - without a password.</li>
    <li>auto_login(). Logs in the user automatically.</li>
</ul>
<strong>The User model</strong></p>
<p>Model_Auth_User defines two relationships:</p>
<pre class="hljs"><code><span class="hljs-comment">// Relationships</span>
<span class="hljs-keyword">protected</span> <span class="hljs-variable">$_has_many</span> <span class="hljs-subst">=</span> <span class="hljs-built_in">array</span>
(
    <span class="hljs-string">&#39;user_tokens&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-string">&#39;model&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;user_token&#39;</span>),
    <span class="hljs-string">&#39;roles&#39;</span>       <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-string">&#39;model&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;role&#39;</span>, <span class="hljs-string">&#39;through&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;roles_users&#39;</span>),
);</code></pre><p>These relationships connect the user to Roles and tokens. Roles are particular sets of rights, such as &quot;admin&quot;. Tokens are used for two purposes: automatic login using cookies and password reset using password reset tokens. A user can have multiple tokens.</p>
<p>Model_Auth_User defines additional rules and callbacks for the username, email and password fields.</p>
<pre class="hljs"><code>    <span class="hljs-comment">// Rules</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$<em>rules</span> <span class="hljs-subst">=</span> <span class="hljs-built_in">array</span>
    (
        <span class="hljs-string">&#39;username&#39;</span>            <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>
        (
            <span class="hljs-string">&#39;not_empty&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">NULL</span>,
            <span class="hljs-string">&#39;min_length&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-number">4</span>),
            <span class="hljs-string">&#39;max_length&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-number">32</span>),
            <span class="hljs-string">&#39;regex&#39;</span>            <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-string">&#39;/^[-pLpN</em>.]++$/uD&#39;</span>),
        ),
        <span class="hljs-string">&#39;password&#39;</span>            <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>
        (
            <span class="hljs-string">&#39;not_empty&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">NULL</span>,
            <span class="hljs-string">&#39;min_length&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-number">5</span>),
            <span class="hljs-string">&#39;max_length&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-number">42</span>),
        ),
        <span class="hljs-string">&#39;password_confirm&#39;</span>    <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>
        (
            <span class="hljs-string">&#39;matches&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-string">&#39;password&#39;</span>),
        ),
        <span class="hljs-string">&#39;email&#39;</span>                <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>
        (
            <span class="hljs-string">&#39;not_empty&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">NULL</span>,
            <span class="hljs-string">&#39;min_length&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-number">4</span>),
            <span class="hljs-string">&#39;max_length&#39;</span>        <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">array</span>(<span class="hljs-number">127</span>),
            <span class="hljs-string">&#39;validate::email&#39;</span>    <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-built_in">NULL</span>,
        ),
    );</code></pre><p>It also provides a number of functions:</p>
<p><ul>
    <li>login(). First argument is an array containing username and password, the second argument is an optional URL to redirect to.</li>
    <li>change_password(). Allows the password to be changed. First argument is an array containing password and password_confirm, second is an optional URL which if given causes the value to be saved immediately and redirected to the given URL.</li>
    <li>username_available(). A callback used in the validation process which checks that the username is available when creating a user.</li>
    <li>email_available(). A callback used in the validation process which checks that the email address is unique.</li>
    <li>save(). A save() function that causes the password to be hashed before saving if it was changed.</li>
</ul>
<strong>The Role model</strong></p>
<p>Roles have a name and a description (a line of text). They are associated with users through the roles_users table. The model does not implement any functions, only a number of rules stored in $_rules.</p>
<p><strong>The User_token model</strong></p>
<p>User_tokens have a unique token and an expiry date. The token can be generated by using create_token() and housekeeping (removing the expired tokens) can be performed using delete_expired(). When the token is saved, the user agent of the current request is saved.</p>
<p>Tokens are essentially unique authorizations either related to password resets or to auto login.</p>
<h2 id="comments">Comments</h2>
<p><strong><a href="#122" title="2010-09-12 09:13:07">codeho</a>:</strong> Hey thanks for your explanation.
i was wondering if you know how i can get a users role into the user object,
so that i can check for it in the controller.</p>
<p>thanks</p>
<p><strong><a href="#123" title="2010-09-13 21:28:24">Jasper</a>:</strong> Hi, I really love your tutorial over here. I cant wait to experiment with it, so I hope the 3rd part will be online soon. Thanks!</p>
<p><strong><a href="#125" title="2010-10-19 20:49:49">Diwant Vaidya</a>:</strong> Mixu, ty for the article.</p>
<p>codeho, try doing Auth::instance()-&gt;get_user()-&gt;roles-&gt;find_all()  which you can do from inside your controller.  It will get you all the roles the user has.</p>
<p><strong><a href="#128" title="2012-01-05 14:51:05">Kostas</a>:</strong> Hello,
How can I change the password for a user when using the file driver?</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>