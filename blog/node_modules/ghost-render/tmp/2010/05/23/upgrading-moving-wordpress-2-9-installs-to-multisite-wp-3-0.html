<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Upgrading / moving Wordpress 2.9 installs to multisite WP 3.0</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Upgrading / moving Wordpress 2.9 installs to multisite WP 3.0">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Upgrading / moving Wordpress 2.9 installs to multisite WP 3.0">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/05/23/upgrading-moving-wordpress-2-9-installs-to-multisite-wp-3-0.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/05/23/upgrading-moving-wordpress-2-9-installs-to-multisite-wp-3-0.html" itemprop="url">Upgrading / moving Wordpress 2.9 installs to multisite WP 3.0</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-05-23" itemprop="datePublished">May 23, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>In the <a href="http://blog.mixu.net/2010/05/17/setting-up-multisite-wordpress-3-0-with-multiple-different-domains/">previous blog</a> post I discussed <a href="http://blog.mixu.net/2010/05/17/setting-up-multisite-wordpress-3-0-with-multiple-different-domains/">how the multi-site functionality in WP 3.0 can be enabled</a> and how it can be hacked to use multiple different domains. Now, let&#39;s have a look at how you can migrate all of your old WP 2.9 sites under a single WP3.0 installation.</p>
<p>The basic steps are:</p>
<p><ol>
    <li>Move posts</li>
    <li>Move attached files</li>
    <li>Fix URLs in posts</li>
    <li>Move/recreate users</li>
</ol></p>
<p><h3>1. Moving the posts from WP 2.9 to 3.0</h3>
Moving the posts, links, comments and terms to WP 3.0 is quite easy. A table-by-table comparison shows that the main tables have identical structures (comparison between a 2.9.2 site and 3.0 beta 2). This means that we can use SQL for the migration. Alternatively, you could export and import (see the functionality under Tools -&gt; Export / Import).</p>
<p>In WP 3.0, the tables are sharded - each blog has it&#39;s own set of tables, and the id of the blog is used as a part of the table name: for example, wp_2_commentmeta is the wp_commentmeta table for the multisite blog with id=2. Find out what the blog_id for your blog is, and use it in the SQL queries below.</p>
<p>I performed the following queries, which move all the tables EXCEPT the options table. Moving the options table seems to result in a broken blog, since the themes, settings and plugins referenced by Wordpress will not exist in the new environment.</p>
<p><pre lang="sql">TRUNCATE newblog.wp_2_commentmeta;
INSERT INTO newblog.wp_2_commentmeta SELECT * FROM oldblog.wp_commentmeta;</p>
<p>TRUNCATE newblog.wp_2_comments;
INSERT INTO newblog.wp_2_comments SELECT * FROM oldblog.wp_comments;</p>
<p>TRUNCATE newblog.wp_2_links;
INSERT INTO newblog.wp_2_links SELECT * FROM oldblog.wp_links;</p>
<p>TRUNCATE newblog.wp_2_postmeta;
INSERT INTO newblog.wp_2_postmeta SELECT * FROM oldblog.wp_postmeta;</p>
<p>TRUNCATE newblog.wp_2_posts;
INSERT INTO newblog.wp_2_posts SELECT * FROM oldblog.wp_posts;</p>
<p>TRUNCATE newblog.wp_2_terms;
INSERT INTO newblog.wp_2_terms SELECT * FROM oldblog.wp_terms;</p>
<p>TRUNCATE newblog.wp_2_term_relationships;
INSERT INTO newblog.wp_2_term_relationships SELECT * FROM oldblog.wp_term_relationships;</p>
<p>TRUNCATE newblog.wp_2_term_taxonomy;
INSERT INTO newblog.wp_2_term_taxonomy SELECT * FROM oldblog.wp_term_taxonomy;</pre>
<strong>What if these queries fail?</strong></p>
<p>Some Wordpress plugins modify the default tables - which means there are extra fields that need to be ignored. If the INSERT INTO statements below don&#39;t work for you, you need to explicitly state the names of the source and destination fields instead of using *. This means losing the added fields, so you need to think about it on a case-by-case basis. See the MySQL docs for INSERT INTO ... SELECT syntax.</p>
<p><h3>2. Moving attached files</h3>
WP 3.0 uses a slightly different directory structure for multisite. The files for each blog are under blogs.dir/[blog_id]/, and use the same substructure as before. Hence, the new directory structure is like this:</p>
<pre class="hljs"><code>/wp-content/blogs.dir/[blog_id]/files/<span class="hljs-keyword">...</span></code></pre><p>and if you keep using the same structure (ex. &quot;year/month/filename&quot;) you can just copy the files:</p>
<pre class="hljs"><code><span class="hljs-built_in">mkdir</span> -<span class="hljs-keyword">p</span> ./<span class="hljs-keyword">wp</span>-content/blogs.dir/[blog_id]/<span class="hljs-keyword">files</span>/</code></pre><pre class="hljs"><code>cp -R .<span class="hljs-regexp">/oldblog/</span>wp-content<span class="hljs-regexp">/uploads/</span>* .<span class="hljs-regexp">/newblog/</span>wp-content<span class="hljs-regexp">/blogs.dir/</span>[blog_id]<span class="hljs-regexp">/files/</span></code></pre><p><h3>3. Fixing URLs in posts</h3>
Try loading a post with images. The URLs (may) change from:
<a href="http://blog.domain.com/wp-content/uploads/2010/04/image.png">http://blog.domain.com/wp-content/uploads/2010/04/image.png</a>
to:
<a href="http://blog.domain.com/files/2010/04/image.png">http://blog.domain.com/files/2010/04/image.png</a></p>
<p>You can fix this by performing a replace on the wp_[blog_id]_posts table:</p>
<p><pre lang="sql">UPDATE wp_2_posts SET guid = replace(guid, &quot;<a href="http://oldblog.domain.com/wp-content/uploads">http://oldblog.domain.com/wp-content/uploads</a>&quot;, &quot;<a href="http://blog.domain.com/files">http://blog.domain.com/files</a>&quot;);
UPDATE wp_2_posts SET post_content_filtered = replace(post_content_filtered, &quot;<a href="http://oldblog.domain.com/wp-content/uploads">http://oldblog.domain.com/wp-content/uploads</a>&quot;, &quot;<a href="http://blog.domain.com/files">http://blog.domain.com/files</a>&quot;);
UPDATE wp_2_posts SET pinged = replace(pinged, &quot;<a href="http://oldblog.domain.com/wp-content/uploads">http://oldblog.domain.com/wp-content/uploads</a>&quot;, &quot;<a href="http://blog.domain.com/files">http://blog.domain.com/files</a>&quot;);
UPDATE wp_2_posts SET post_excerpt = replace(post_excerpt, &quot;<a href="http://oldblog.domain.com/wp-content/uploads">http://oldblog.domain.com/wp-content/uploads</a>&quot;, &quot;<a href="http://blog.domain.com/files">http://blog.domain.com/files</a>&quot;);
UPDATE wp_2_posts SET post_content = replace(post_content, &quot;<a href="http://oldblog.domain.com/wp-content/uploads">http://oldblog.domain.com/wp-content/uploads</a>&quot;, &quot;<a href="http://blog.domain.com/files">http://blog.domain.com/files</a>&quot;);</pre>
If you also changed the domain, you need to fix the links (do this after you fix the file upload paths):</p>
<p><pre lang="sql">UPDATE wp_2_posts SET guid = replace(guid, &quot;<a href="http://oldblog.domain.com">http://oldblog.domain.com</a>&quot;, &quot;<a href="http://blog.domain.com">http://blog.domain.com</a>&quot;);
UPDATE wp_2_posts SET post_content_filtered = replace(post_content_filtered, &quot;<a href="http://oldblog.domain.com">http://oldblog.domain.com</a>&quot;, &quot;<a href="http://blog.domain.com">http://blog.domain.com</a>&quot;);
UPDATE wp_2_posts SET pinged = replace(pinged, &quot;<a href="http://oldblog.domain.com">http://oldblog.domain.com</a>&quot;, &quot;<a href="http://blog.domain.com">http://blog.domain.com</a>&quot;);
UPDATE wp_2_posts SET post_excerpt = replace(post_excerpt, &quot;<a href="http://oldblog.domain.com">http://oldblog.domain.com</a>&quot;, &quot;<a href="http://blog.domain.com">http://blog.domain.com</a>&quot;);
UPDATE wp_2_posts SET post_content = replace(post_content, &quot;<a href="http://oldblog.domain.com">http://oldblog.domain.com</a>&quot;, &quot;<a href="http://blog.domain.com">http://blog.domain.com</a>&quot;);</pre></p>
<p><h3>4. Moving the users</h3>
You can either 1) manually create new user accounts for your users, or 2) try to move the user accounts. Most blogs don&#39;t really have many users beyond the admin, since commenting doesn&#39;t need a user account. My recommendation would be to manually add the very few users you have.</p>
<p>If you want to move the users in bulk using SQL, then you will need to take into account that:</p>
<p><ol>
    <li>In WP 3.0, the <em>wp_users </em>table is shared among <em>all the sites</em>.</li>
    <li>The wp_users table in WP 3.0 has two extra fields: spam and deleted.</li>
    <li>Each blog site has its own <em>wp_capabilities</em>, <em>wp_user-settings</em> and <em>wp_user-settings_time</em> fields (e.g. wp_2_capabilities) in the <em>wp_users</em> table. The format (serialized PHP arrays) appears to be the same, so you will need to create one user with the rights you want manually, then these three keys for each of the blogs you want to user to be able to access.</li>
</ol>
I didn&#39;t try this out, since the blogs I have only use a small number of users. I just created individual admin accounts for those blogs that I am not administering personally.</p>
<h2 id="comments">Comments</h2>
<p><strong><a href="#204" title="2010-06-24 14:26:00">Hikari</a>:</strong> That&#39; tricky!</p>
<p>It&#39;s exactally what I wanna do with my sites, tnx for the tutorial!</p>
<p>Could you make a tutorial about wp_options? :D</p>
<p><strong><a href="#205" title="2010-07-22 12:40:39">leenoux</a>:</strong> thank you,</p>
<p>you save me lots of time :)</p>
<p><strong><a href="#206" title="2010-10-07 15:28:18">John</a>:</strong> This post is the Holy Grail. This information is completely missing from the official Wordpress documentation on how to start a network. They don&#39;t factor in the possibility that we may have EXISTING sites to bring into a network.</p>
<p>This saved me many, many hours of frustration. Thank you.</p>
<p><strong><a href="#208" title="2011-02-10 15:20:38">Seluna</a>:</strong> I am so glad I found this post of yours. I tried the Import/Export method and compared to that, your method is much much quicker. Thank you so much!</p>
<p>I have a little trick with the wp_options though, and what I do is in the old website, I access the &quot;<a href="http://www.domain.com/wp-admin/options.php">http://www.domain.com/wp-admin/options.php</a>&quot; page and I save it down into my computer. Then I access the options.php page for the new website, open the saved options.php and I manually match the fields and change the values to fit.</p>
<p>It&#39;s actually faster then going through the options pages one by one.</p>
<p><strong><a href="#209" title="2011-02-10 15:28:57">Mikito Takada</a>:</strong> Thanks for the tip!</p>
<p><strong><a href="#211" title="2011-02-10 19:57:13">Seluna</a>:</strong> Haha, no problem! Sharing makes the word go round!</p>
<p><strong><a href="#212" title="2011-02-24 18:47:15">Ian Dunn</a>:</strong> I recently had to work out a process for a client where I needed to migrate the options, users, and everything else completely in tact. It takes a little bit of work, but it&#39;s definitely possible. I wrote up a detailed description of the process at <a href="http://iandunn.name/workblog/comprehensive-wordpress-multisite-migrations/">http://iandunn.name/workblog/comprehensive-wordpress-multisite-migrations/</a></p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>