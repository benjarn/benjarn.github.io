<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Setting up private SSH-based Mercurial repo hosting on Centos</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Setting up private SSH-based Mercurial repo hosting on Centos">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Setting up private SSH-based Mercurial repo hosting on Centos">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/10/04/setting-up-private-ssh-based-mercurial-repo-hosting-on-centos.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/10/04/setting-up-private-ssh-based-mercurial-repo-hosting-on-centos.html" itemprop="url">Setting up private SSH-based Mercurial repo hosting on Centos</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-10-04" itemprop="datePublished">October 04, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>In this tutorial, I walk through the steps to setup Mercurial repo hosting using Mercurial-server on Centos, and setting up Putty+Mercurial on Windows to enable access. There are a lot of small things that seemed to be missing from the existing guides, so I try to cover those to help you save time in getting this set up.</p>
<h2>1. Install mercurial-server</h2>
As stated on <a href="http://mercurial.selenic.com/wiki/SharedSSH">http://mercurial.selenic.com/wiki/SharedSSH</a>, Mercurial-server is not a server but rather a management interface which uses a single shared SSH login for access and some additional logic to allow user rights to be limited.

Installing mercurial-server (version 1.0.1) on Centos requires that you tweak the makefile a bit, because it was originally designed for Debian-based systems and there are a few problems. Unfortunately, I haven&#39;t found a repo that would have mercurial-server, so there are a couple of manual steps involved.

First, install the prerequisites:

<code>bash
yum install python python-setuptool* mercurial make</code>

Then, download the source from <a href="http://www.lshift.net/mercurial-server.html">http://www.lshift.net/mercurial-server.html</a> and untar it on the server.

Open &quot;Makefile&quot; in the source directory, and make the following changes:
<ol>
    <li>For the line  &quot;installfiles: installetc installdoc pythoninstall&quot;, remove &quot;installdoc&quot;. Result should be &quot;installfiles: installetc pythoninstall&quot;. The reason why this is necessary is documented <a href="http://websaucesoftware.com/blog/?p=497">here</a>.</li>
    <li>For the line saying &quot;useradd --system --shell /bin/sh &quot;, change to &quot;useradd -r --shell /bin/sh &quot;. At least for me, the useradd command did not recognize the --system switch, so I had to use -r instead. I guess you could also remove it.</li>
</ol>
After this, run:

<code>bash
make setup-useradd</code>

(need root privileges) . I remember getting some minor warning, but it didn&#39;t seem to be a problem.
<h2>2. Copy your public key which you want to use to login onto the server</h2>
As stated in the Mercurial-server docs, you need to add the public key you want to use into /etc/mercurial-server/keys/root/put-your-username-here/put-an-easy-to-remember-name-for-your-keyfile-here .

If you are using Putty, make sure you have allowed agent forwarding under Connection -&gt; SSH -&gt; Auth -&gt; Authentication parameters -&gt; Allow agent forwarding so that ssh-add will work properly. This way you don&#39;t have to mess around with Puttygen (well, the alternative is just to open the file, then paste the OpenSSH format public key to a file and then uploading it).

Then run refresh-auth. It is actually under /usr/local/share/mercurial-server/refresh-auth instead of /usr/share (as it is in the documentation). Here are the steps on the remote server after logging in (from <a href="http://dev.lshift.net/paul/mercurial-server/docbook.html">mercurial-server documentation</a>):

<code>bash
$ ssh-add -L &amp;gt; my-key
$ sudo mkdir -p /etc/mercurial-server/keys/root/your-username
$ sudo cp my-key /etc/mercurial-server/keys/root/your-username/an-easy-to-remember-name-for-keyfile
$ sudo -u hg /usr/share/mercurial-server/refresh-auth&lt;span style=&quot;font-family: Georgia, &#39;Times New Roman&#39;, &#39;Bitstream Charter&#39;, Times, serif; font-size: x-large;&quot;&gt;&lt;span style=&quot;line-height: 19px; white-space: normal;&quot;&gt;&lt;strong&gt;
&lt;/strong&gt;&lt;/span&gt;&lt;/span&gt;</code>

<h2>3. Ensure that you can login using hg@yourserver</h2>
You first need to be able to login as hg before you can use the system. So test this out by connecting to the server using Putty (obviously, this has to be public key auth, not password auth - Google for a better tutorial on that if necessary).

Most likely, you will need to first unlock the hg account. This is because under Red Hat-based distros, users are created in a locked state (= unable to login, see also: <a href="http://www.centos.org/docs/5/html/Deployment_Guide-en-US/s1-users-tools.html">documentation</a>). This will show up under /var/log/secure as &quot;sshd[15245]: User hg not allowed because account is locked&quot;.

To unlock the hg user, setup the account password using:

<code>bash
passwd hg</code>

This should result in the account becoming unlocked.

If you are still unable to login, check the sshd_config file under /etc/ssh/sshd_config.

There are a couple of settings that have to be in place, most obviously:

<code>bash
PubkeyAuthentication yes
AuthorizedKeysFile      .ssh/authorized_keys
AllowUsers hg and-all-the-other-allowed-users</code>

and have a look for AllowGroups/DenyGroups/DenyUsers. Remember that AllowUsers is a whitelist, you have to specify all the accounts that are allowed to log in using ssh (separated by spaces). Not having it set should be equivalent to &quot;AllowUsers *&quot;.

Remember to restart sshd if you do change the settings.
<h2>4a. Setup Mercurial on Windows to use the correct key</h2>
If you are using Putty on Windows for your client repo access, you need these settings.

In C:UsersaccountnameMercurial.ini, add the following under the [ui] section:

<code>bash
ssh=&quot;C:Program Files (x86)PuTTYplink.exe&quot; -ssh -2 -batch -C -i &quot;D:some-pathkey-file.ppk&quot;</code>

To test the connection, run:

<code>bash
&quot;C:Program Files (x86)PuTTYplink.exe&quot; -ssh -2 -batch -C -v -i &quot;D:some-pathkey-file.ppk&quot; hg@servername ls</code>

You should be able to login.

If you keep getting another IP address, make sure your Putty default settings IP is empty. And if you get a &quot;Disconnected: User aborted at host key verification&quot;, log in once using Putty and accept the server&#39;s host key.
<h2>4b. Setup Mercurial on Fedora/Centos/Redhat to use the correct key</h2>
If you are using ssh+hg on Linux for your client repo access, you need these settings.

You will need to add your key to the /var/lib/mercurial-server/.ssh/authorized_keys file, either manually or by using the steps in stage 2.

To set up the private key, edit or create ~/.ssh/config:

Host servername-or-ip
User hg
IdentityFile ~/path-to-keyfile

To test the connection, run:

ssh servername-or-ip

To set up the default pull and push locations for hg push and hg pull, change .hg/hgrc:

[paths]
default = ssh://hg@servername/reponame
default-push = ssh//:hg@servername/reponame

Further, much more detailed documentation on the hgrc file <a href="http://www.selenic.com/mercurial/hgrc.5.html">is available from Selenic</a>.
<h2>5. That&#39;s it, clone your repo to the server</h2>

<pre class="hljs"><code><span class="hljs-title">hg</span> clone --<span class="hljs-built_in">debug</span> -v . <span class="hljs-url">ssh://hg<span class="hljs-variable">@servername</span>/name-of-the-repo</span></code></pre><p>The additional switches will help in showing what is being done.</p>
<p>BTW, remember to specify the source for what you are cloning (e.g. &quot;.&quot;).</p>
<h2 id="comments">Comments</h2>
<p><strong><a href="#247" title="2011-03-01 09:30:35">Roshan</a>:</strong> Shameless Plug: If you care, there is also hg-gateway for scenarios where you don&#39;t have root access on the machine, such as the case with shared hosting accounts.</p>
<p><a href="http://parametricity.net/b/2011/02/20/hg-gateway-supporting-multiple-mercurial-users-on-a-shared-ssh-account/">http://parametricity.net/b/2011/02/20/hg-gateway-supporting-multiple-mercurial-users-on-a-shared-ssh-account/</a></p>
<p><strong><a href="#248" title="2011-12-08 06:21:36">Nick Doyle</a>:</strong> Thanks for the writeup.
Heads-up: mercurial-server apparently written for python 2.5+
while default CentOS 5.5 yum repositories currently are at 2.4.3
Resulting issue comes when hg push:</p>
<p>remote: error: changegroup.aaaaa_servelog hook raised an exception: &#39;module&#39; object has no attribute &#39;SEEK_END&#39;</p>
<p>According to python doco os.SEEK_END is new in python 2.5, with a value of 2
<a href="http://docs.python.org/library/os.html">http://docs.python.org/library/os.html</a></p>
<p>Need to either install python 2.5+
or like my quick hack, edit 2 files and replace &quot;os.SEEK_END&quot; with the number 2
Files needed to edit are:
build/lib/mercurialserver/servelog.py
src/mercurialserver/servelog.py</p>
<p><strong><a href="#249" title="2012-05-14 15:08:13">dEadY</a>:</strong> My first hg push gave me the following error, after I added a public key in the hgadmin repository:</p>
<p>remote: added 1 changesets with 1 changes to 1 files
remote: error: changegroup.aaaaa_servelog hook raised an exception: No module named simplejson</p>
<p>Since that error I&#39;m not able to access the server:</p>
<p>remote: mercurial-server: access denied
abort: no suitable response from remote hg!</p>
<p>I&#39;ve installed the python-simplejson package on the server, but of course that doesn&#39;t change the fact that I can&#39;t login anymore. I&#39;ve checked mercurial&#39;s key directories (nothing changed there) and again executed
sudo -u hg /usr/local/share/mercurial-server/refresh-auth
but no luck so far.
Any idea how to fix that again?</p>
<p><strong><a href="#250" title="2012-06-12 17:59:29">John Airey</a>:</strong> I&#39;ve hit on this problem twice the solution is this in ~hg/.bashrc</p>
<p>export PYTHONPATH=&#39;/usr/local/share/mercurial-server&#39;</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>