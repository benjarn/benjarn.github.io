<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>How to use Kohana 3 validation (with forms)</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="How to use Kohana 3 validation (with forms)">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="How to use Kohana 3 validation (with forms)">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/10/30/how-to-use-kohana-3-validation-with-forms.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/10/30/how-to-use-kohana-3-validation-with-forms.html" itemprop="url">How to use Kohana 3 validation (with forms)</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-10-30" itemprop="datePublished">October 30, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>Update: I am gradually updating my Kohana 3.0 articles to Kohana 3.1.</p>
<p><h2>Overview of Kohana 3 validation</h2>
<a href="http://kohanaframework.org/guide/security.validation">Validation</a> is done using the Validation class, or via ORM <del>using $model-&gt;check()</del> automatically via exceptions. It uses the messages functionality in KO3, which is a system for specifying validation messages for various forms (I will discuss this).</p>
<p>The steps in validating a form are:</p>
<p><ol>
    <li>Initialize the Validation class.</li>
    <li>Call Validate-&gt;check() and check whether the validation succeeded.</li>
    <li>If the validation failed, call errors($file) to get the error messages.</li>
    <li>Display the validation errors in the correct context on the form.</li>
</ol>
The first steps are covered by existing documentation, so I will focus on the last two steps here.</p>
<p><h2>Initializing the Validation class</h2>
In Kohana 3.1, the Validation class is simply initialized by setting up rules. The class has also changed from Validate (KO 3.0) to Validation (KO 3.1).</p>
<p><strong>Rules.</strong> The Validation class has a nice set of basic validation rules, including rules for email addresses, credit cards, URLs and regexps.</p>
<p><strong>KO 3.0 migration notes</strong></p>
<p>KO 3.1 validation no longer has callbacks or filters. Callbacks have been merged into rules, while filters have been removed altogether.</p>
<p>Filters were used to do things like trim() the input in KO 3.0.x - you can do array_map($array, &#39;trim&#39;).</p>
<p>Callbacks are now specified using the rule() function, see <a href="http://blog.lysender.com/2011/02/kohana-3-1-validation-adventures/">this excellent tutorial from Lysender for the details</a>!</p>
<p><h2>Some sample code</h2>
&nbsp;</p>
<pre class="hljs"><code><span class="hljs-comment">// Create a validation object</span>
<span class="hljs-variable">$validation</span> <span class="hljs-subst">=</span> Validation<span class="hljs-tag">::factory</span>(
   <span class="hljs-built_in">array</span>(
    <span class="hljs-string">&#39;email&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;no-reply@test.com&#39;</span>,
    <span class="hljs-string">&#39;name&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;Test&#39;</span>
    );
<span class="hljs-comment">// Add some basic rules</span>
<span class="hljs-variable">$validation</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;rule(<span class="hljs-string">&#39;name&#39;</span>, <span class="hljs-string">&#39;not_empty&#39;</span>);
<span class="hljs-variable">$validation</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;rule(<span class="hljs-string">&#39;email&#39;</span>, <span class="hljs-string">&#39;email&#39;</span>);
<span class="hljs-comment">// Check the result</span>
<span class="hljs-variable">$validation</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;check();

<span class="hljs-comment">// Using a single Kohana_Valid::rule</span>
<span class="hljs-comment">// for just checking a single field</span>
<span class="hljs-keyword">if</span>(Valid<span class="hljs-tag">::email</span>(<span class="hljs-string">&#39;test@test.com&#39;</span>)) {
   <span class="hljs-comment">// do something with the email</span>
}</code></pre><p><span style="font-size: 20px; font-weight: bold;">Retrieving and customizing error messages</span></p>
<p>Validation can be done for both models (on save) and various other forms. Because of this the messages are stored in separate, reusable files. You should put your message files under /application/messages/filename.php.</p>
<p>I think the logic behind this has gotten a bit more complicated for KO 3.1 - in particularly with validation messages from the ORM... have to get back to you on that.</p>
<p>The files look like this:</p>
<pre class="hljs"><code><span class="hljs-keyword">array</span>(
<span class="hljs-attribute">&#39;username</span>&#39; =&amp;gt; <span class="hljs-keyword">array</span>(
   <span class="hljs-attribute">&#39;username_available</span>&#39; =&amp;gt; <span class="hljs-attribute">&#39;This</span> username <span class="hljs-keyword">is</span> already...&#39;,
   <span class="hljs-attribute">&#39;not_empty</span>&#39; =&amp;gt; <span class="hljs-attribute">&#39;Username</span> must <span class="hljs-keyword">not</span> be empty.&#39;,
   <span class="hljs-attribute">&#39;invalid</span>&#39; =&amp;gt; <span class="hljs-attribute">&#39;Password</span> <span class="hljs-keyword">or</span> username <span class="hljs-keyword">is</span> incorrect.&#39;,
),
<span class="hljs-attribute">&#39;password</span>&#39; =&amp;gt; <span class="hljs-keyword">array</span>(
   <span class="hljs-attribute">&#39;matches</span>&#39; =&amp;gt; <span class="hljs-attribute">&#39;The</span> password <span class="hljs-keyword">and</span> password confirmation ..&#39;,
   <span class="hljs-attribute">&#39;range</span>&#39; =&amp;gt; &#39;:field must be within the <span class="hljs-keyword">range</span> <span class="hljs-keyword">of</span> :param1 <span class="hljs-keyword">to</span> :param2&#39;,
),
);</code></pre><p>Each field is a sub-array and each rule has it&#39;s own field. Note that you can use :field to specify the field name.</p>
<p>To retrieve the messages, use $validate-&gt;errors($file) where $file is the filename (no extension).</p>
<p>The return value looks something like:</p>
<pre class="hljs"><code><span class="hljs-keyword">array</span>(
   <span class="hljs-attribute">&#39;password</span>&#39; =&amp;gt; <span class="hljs-attribute">&#39;password</span> must be less than <span class="hljs-number">42</span> characters long&#39;,
   <span class="hljs-attribute">&#39;password_confirm</span>&#39; =&amp;gt; <span class="hljs-attribute">&#39;The</span> password <span class="hljs-keyword">and</span> password confirmation are different.&#39;,
   <span class="hljs-attribute">&#39;username</span>&#39; =&amp;gt; <span class="hljs-attribute">&#39;This</span> username <span class="hljs-keyword">is</span> already registered, please choose another one.&#39;,
   <span class="hljs-attribute">&#39;email</span>&#39; =&amp;gt; <span class="hljs-attribute">&#39;This</span> email address <span class="hljs-keyword">is</span> already <span class="hljs-keyword">in</span> <span class="hljs-keyword">use</span>.&#39;);</code></pre><p>The simplest way to show these is the just print them in as a list. However, I will show one way to show these messages in context on the actual form.</p>
<p><h2>Displaying validation errors in context on the form</h2>
Here is how we want to show the forms:</p>
<p><a href="http://blog.mixu.net/files/2010/10/validation1.png"><img class="alignnone size-full wp-image-1200" title="validation" src="http://blog.mixu.net/files/2010/10/validation1.png" alt="" width="650" height="147" /></a></p>
<p>To accomplish this, I have created a new<a href="https://bitbucket.org/mixu/appform/src/tip/application/classes/appform.php"> Appform helper</a> which uses the Form class, but wraps its input with application-specific markup for errors.</p>
<p>The basic idea is that you can pass <a href="https://bitbucket.org/mixu/appform/src/tip/application/views/register.php">default values, form values and error messages</a> to Appform prior to outputting the fields. It will then create the contextual markup for each of the fields. I have maintained compatibility with the Form API, with additional properties for added functionality.</p>
<p>Note: for Kohana 3.1, you need to move the error messages from _external to the base for Appform to work.</p>
<pre class="hljs"><code><span class="hljs-variable">$errors</span> = <span class="hljs-variable">$e</span>-&amp;gt;errors(<span class="hljs-string">&#39;register&#39;</span>);
<span class="hljs-variable">$errors</span> = array_merge(<span class="hljs-variable">$errors</span>, (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$errors</span>[<span class="hljs-string">&#39;_external&#39;</span>]) ? <span class="hljs-variable">$errors</span>[<span class="hljs-string">&#39;_external&#39;</span>] : <span class="hljs-keyword">array</span>()));
<span class="hljs-variable">$view</span>-&amp;gt;set(<span class="hljs-string">&#39;errors&#39;</span>, <span class="hljs-variable">$errors</span>);</code></pre><p>As a side note, I think this is exactly how the division of labor between framework and application developer should be: the framework should not impose a particular markup on the developer, but to keep application-specific code shorter, the developer should be able to create an extended version of the Form helper for the basic form layout. There are too many different preferred styles of markup, and the framework should not try to guess how you like your forms but rather provide the backend. Kohana gets this right.</p>
<p>Here is how a sample invocation would look like (note that the Appform class is not static, since each form has its own contextual data):</p>
<pre class="hljs"><code><span class="hljs-variable">$form</span> = <span class="hljs-keyword">new</span> Appform();
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$defaults</span>)) {
  <span class="hljs-variable">$form</span>-&amp;gt;defaults = <span class="hljs-variable">$defaults</span>;
}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$errors</span>)) {
  <span class="hljs-variable">$form</span>-&amp;gt;errors = <span class="hljs-variable">$errors</span>;
}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$values</span>)) {
  <span class="hljs-variable">$form</span>-&amp;gt;values = <span class="hljs-variable">$values</span>;
}
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$form</span>-&amp;gt;open(<span class="hljs-string">&#39;user/login&#39;</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&#39;&amp;lt;ul&amp;gt;&#39;</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">&#39;&amp;lt;li&amp;gt;&#39;</span>.<span class="hljs-variable">$form</span>-&amp;gt;label(<span class="hljs-string">&#39;username&#39;</span>, <strong>(<span class="hljs-string">&#39;Username&#39;</span>)).<span class="hljs-string">&#39;&amp;lt;/li&amp;gt;&#39;</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$form</span>-&amp;gt;input(<span class="hljs-string">&#39;username&#39;</span>, <span class="hljs-keyword">NULL</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#39;info&#39;</span> =&amp;gt; </strong>(<span class="hljs-string">&#39;You can also log in using your email address instead of your username.&#39;</span>)));
<span class="hljs-keyword">echo</span> <span class="hljs-string">&#39;&amp;lt;li&amp;gt;&#39;</span>.<span class="hljs-variable">$form</span>-&amp;gt;label(<span class="hljs-string">&#39;password&#39;</span>, <strong>(<span class="hljs-string">&#39;Password&#39;</span>)).<span class="hljs-string">&#39;&amp;lt;/li&amp;gt;&#39;</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$form</span>-&amp;gt;input(<span class="hljs-string">&#39;password&#39;</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&#39;&amp;lt;/ul&amp;gt;&#39;</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$form</span>-&amp;gt;submit(<span class="hljs-keyword">NULL</span>, </strong>(<span class="hljs-string">&#39;Login&#39;</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$form</span>-&amp;gt;close();</code></pre><p>You can <a href="https://bitbucket.org/mixu/appform/src">download my form validation helper from Bitbucket</a>. It&#39;s only a couple of hundred lines so it is easy to improve - a useful start for building more complex functionality for your app and also to reduce the lines of code needed for each form.</p>
<p><h2>ORM and form validation (still need to update to KO 3.1)</h2>
The Kohana ORM provides support for field validation. However, it is very much oriented towards each model having one set of validations. With ORM, the function calls are:</p>
<pre class="hljs"><code><span class="hljs-keyword">if</span> ( <span class="hljs-subst">!</span>empty(<span class="hljs-variable">$_POST</span>) <span class="hljs-subst">&amp;</span>amp;<span class="hljs-subst">&amp;</span>amp; is_numeric(<span class="hljs-variable">$id</span>) ) {
   <span class="hljs-variable">$model</span> <span class="hljs-subst">=</span> ORM<span class="hljs-tag">::factory</span>(<span class="hljs-string">&#39;user&#39;</span>, <span class="hljs-variable">$id</span>); <span class="hljs-comment">// create</span>
   <span class="hljs-variable">$model</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;values(<span class="hljs-variable">$_POST</span>); <span class="hljs-comment">// load values to model</span>
   <span class="hljs-comment">// check() initializes $model-&amp;gt;_validate with a Validation object containing the</span>
   <span class="hljs-comment">// rules, filters and callbacks from Model_User (e.g. $_rules, $_callbacks..)</span>
   <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;check()) {
      <span class="hljs-variable">$model</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;save(); <span class="hljs-comment">// save the model</span>
   } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Load errors. The first param is the path to the</span>
      <span class="hljs-comment">// message file (e.g. /messages/register.php)</span>
      <span class="hljs-variable">$content</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;errors <span class="hljs-subst">=</span> <span class="hljs-variable">$user</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;validate()<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;errors(<span class="hljs-string">&#39;register&#39;</span>);
   }
}</code></pre><p>You may want to do something different, either using a different set of rules or a different set of features! The classic example is user profile editing, where you do not want to force the user to re-enter their password - so you need to exclude the password rules from the Validation check.</p>
<h2 id="comments">Comments</h2>
<p><strong><a href="#255" title="2011-03-30 17:27:05">NARKOZ</a>:</strong> There are no filters in Kohana 3.1</p>
<p><strong><a href="#256" title="2011-11-19 21:55:54">Palkonyves</a>:</strong> Yep, but you can get the same functionality with own callback as rule e.g.:
function trim<em>(&amp;$value){
  $value = trim($value);
}
$val-&gt;rule(&#39;name&#39;, &#39;trim</em>&#39;, array(&#39;:value&#39;));</p>
<p>my problem with it in kohana 3.2 that I cannot get back the validated array from the Validation object on which I used several callbacks.</p>
<p>I would like something like:
if( $validation-&gt;check() ){
   $validation-&gt;getValidatedData();
}</p>
<p>any idea how to do this without changing this core class?</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>