<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Options for securing PHP in a shared virtual hosting environment</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Options for securing PHP in a shared virtual hosting environment">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Options for securing PHP in a shared virtual hosting environment">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/02/24/options-for-securing-php-in-a-shared-virtual-hosting-environment.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/02/24/options-for-securing-php-in-a-shared-virtual-hosting-environment.html" itemprop="url">Options for securing PHP in a shared virtual hosting environment</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-02-24" itemprop="datePublished">February 24, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>The terms and options for implementing security measures can be quite confusing. This blog post is a survey of the options available, including some possible pros and cons and definitions of relevant terminology.</p>
<p>It is very typical to run multiple sites on a single server, since it would be overkill to run each small website and blog on its own VPS instance. The default Apache setup: mod_php and prefork-mpm does not offer any privilege separation or hardening for virtual hosts. Hence the need for additional security measures.</p>
<p><strong>What are the general approaches taken to securing PHP?</strong></p>
<p>The approaches taken in securing PHP can be divided into two broad categories:</p>
<p><ol>
    <li><strong>Hardening PHP</strong>. This approach aims to improve the security of PHP scripts by limiting dangerous functionality on a site-by-site basis and by preventing flaws from escalating through additional patches to the PHP core. The main examples are: a) tweaking PHP core settings such as open_basedir and b) running a version of PHP which includes additional options to limit functionality and prevent flaws such as buffer overflows (<a href="http://www.hardened-php.net/suhosin/">Suhosin</a>).</li>
    <li><strong>Privilege separation. </strong>This approach limits the extent to which other sites can be damaged if one of the websites on the shared server is compromised. There are several solutions, including <a href="http://www.suphp.org/">mod_suPHP</a> and <a href="http://httpd.apache.org/docs/2.0/suexec.html">suEXEC</a>.</li>
</ol>
<strong>How can PHP and Apache interact?</strong></p>
<p>There are several ways in which PHP and other scripts can be invoked by Apache:</p>
<p><ul>
    <li><a href="http://en.wikipedia.org/wiki/Common_Gateway_Interface">CGI (Common Gateway Interface) </a>is a standard protocol that defines how webserver software can delegate the generation of webpages to a console application. It operates on a &quot;one new process per request&quot; basis.</li>
    <li><a href="http://en.wikipedia.org/wiki/FastCGI">FastCGI</a> is a protocol introduced in the mid-1990s that improves upon the older CGI protocol. It allows a single persistent process pool to handle multiple requests over its lifetime, reducing overhead.</li>
    <li>In-process as an Apache module, such as the default mod_php.</li>
</ul>
The default interaction between PHP and Apache is handled by the mod_php module. The most common ways of implementing privilege separation use either CGI or FastCGI to interface with PHP. PHP supports both CGI and FastCGI protocols.</p>
<p><strong>Privilege separation can be done either:</strong></p>
<p><ol>
    <li>by using CGI scripts and suEXEC, a feature built in Apache</li>
    <li>by using Apache modules that make invoking CGI scripts easier</p>
<p><ul>
    <li><em>Apache modules</em> are bundles that can be loaded to add new functionality to Apache. They are integrated into the Apache server and add new functionality to instances of the server, such as the capability to interpret PHP scripts.</li>
</ul></p>
<p><ul>
    <li>Examples: mod_php, mod_suPHP, mod_fastcgi and mod_fcgid.</li>
</ul>
</li>
    <li>by using Apache MPMs that support privilege separation</p>
<p><ul>
    <li><a href="http://httpd.apache.org/docs/2.0/mpm.html"><em>Apache MPMs</em></a><em> (Multi-Processing Modules)</em> are responsible for binding to network ports on the machine, accepting requests, and dispatching children to handle the requests. There are several different MPMs - the Unix platform default is the prefork mpm.</li>
    <li>Examples: prefork, worker, perchild, mpm_itk, mpm_peruser</li>
</ul>
</li>
</ol>
<strong>What are the options for privilege separation?</strong></p>
<p><strong>suEXEC</strong></p>
<p><strong><span style="font-weight: normal;">suEXEC is a feature built into Apache, but not included in the default Apache installation. It makes all CGI scripts execute with the user id and permissions of their owners. It can be used with PHP and with other CGI scripts.</span></strong></p>
<p>It consists of a setuid &quot;wrapper&quot; binary that is called by the main Apache web server, and which executes CGI scripts with the correct used id.</p>
<ul>
<li><p>Tried and tested</p>
</li>
<li><p>Can be used with other languages than PHP</p>
</li>
<li><p>Low performance without FastCGI (similar to suPHP)</p>
</li>
<li><p>Separate script files are a minor hassle</p>
</li>
</ul>
<p><strong>Module: mod_suPHP </strong></p>
<p>mod_suPHP makes PHP scripts execute with the user id and permissions of their owners.</p>
<p>It consists of an Apache module (mod_suphp) and a setuid root binary (suphp), which calls PHP as a CGI process.</p>
<ul>
<li><p>Easy to install, in RPMForge repo (<a href="http://wiki.centos.org/AdditionalResources/Repositories/RPMForge">http://wiki.centos.org/AdditionalResources/Repositories/RPMForge</a>)</p>
</li>
<li><p>Quite commonly used</p>
</li>
<li><p>Low performance relative to others (similar to suEXEC)</p>
</li>
<li><p>PHP specific solution</p>
</li>
</ul>
<p>= Recommended for low load sites which are not using their resources to their limits.</p>
<p><strong>Module: FastCGI (mod_fastcgi or mod_fcgid)</strong></p>
<p>mod_fastcgi and mod_fcgid implement process persistence between page views and communicate with PHP using FastCGI. They do not by themselves perform privilege separation, suEXEC is needed.</p>
<ul>
<li><p>Decent performance when using suEXEC with FastCGI, similar or better performance than mod_php has been reported</p>
</li>
<li><p>Can be used with other languages than PHP</p>
</li>
<li><p>FastCGI may require more memory because there are more persistent processes (more suited for servers with a lot of memory)</p>
</li>
<li><p>Separate script files are a minor hassle</p>
</li>
</ul>
<p>= Recommended for higher load sites.</p>
<p><strong>MPM: mpm_itk and mpm_peruser</strong></p>
<p>These are alternative MPMs for Apache that replace the default preform MPM and perform additional privilege separation.</p>
<p>mpm_itk works in a manner similar to regular CGI scripts in that it does not reuse processes after each request. However, unlike CGI scripts, it invokes each process with the user id and group specified for that virtual host.</p>
<ul>
<li><p>Neat solution with decent performance, some systems have it in the repos</p>
</li>
<li><p>Must patch and compile separately in Centos</p>
</li>
<li><p>Not as commonly used as suEXEC or suPHP</p>
</li>
</ul>
<p>= Recommended as a upcoming solution that is higher performance than mod_suPHP and easier to setup than suEXEC+FastCgi.</p>
<p>mpm_peruser creates one or more apache child processes for each unique user/group, each handling its own set of virtual hosts.</p>
<ul>
<li><p>Faster than mpm_itk</p>
</li>
<li><p>Must patch and compile separately in most systems</p>
</li>
<li><p>Development and adoption seems to be more limited than mpm_itk</p>
</li>
</ul>
<h2 id="comments">Comments</h2>
<p><strong><a href="#112" title="2010-03-03 09:38:18">PhpCatalog</a>:</strong> I do not recommend Shared Hosting for a serious business</p>
<p><strong><a href="#113" title="2010-03-20 23:48:07">Mikito Takada</a>:</strong> &quot;Shared hosting&quot; here refers to sharing a single VPS among multiple websites. I do agree that keeping physically separate hosts is valuable - but it should not be the only form of security in use.</p>
<p>There are many cases in which a shared environment works better - like hosting a bunch of blogs and brochure websites and still be remain reasonably secure.</p>
<p><strong><a href="#114" title="2011-03-23 15:38:06">Matt Kukowski</a>:</strong> Only problem with suPHP is that it does not allow you to use PHP opcode caching such as APC which greatly speeds up PHP and less disk thrashing.</p>
<p>But, there are other methods, but they are harder to set up.</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>