<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>How to deploy web applications using Mercurial</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="How to deploy web applications using Mercurial">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="How to deploy web applications using Mercurial">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/12/01/how-to-deploy-web-applications-using-mercurial.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/12/01/how-to-deploy-web-applications-using-mercurial.html" itemprop="url">How to deploy web applications using Mercurial</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-12-01" itemprop="datePublished">December 01, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>Does deploying changes to your site take too long? Are you tired of manually sorting out the update? Here is how to deploy your projects using Mercurial.</p>
<p><strong>Why?</strong></p>
<p><ul>
    <li>Ease of updating. Mercurial keeps track of the changes and only sends the necessary changes -  you don&#39;t need to worry about transferring files.</li>
    <li>Make it possible to roll back changes on the deployed site. You can use hg to roll back from a bad update if necessary.</li>
    <li>Once set up, it&#39;s beautiful. &quot;hg deploy&quot;. How can you not like that?</li>
</ul>
How is this different from <a href="http://blog.mixu.net/2010/10/04/setting-up-private-ssh-based-mercurial-repo-hosting-on-centos/">the other guide you wrote about setting up private repo hosting</a>?</p>
<p><ul>
    <li>While the differences aren&#39;t that big, this setup is better for <em>deployment </em>rather than <em>code distribution via repositories</em>:</p>
<p><ul>
    <li>Minimal dependencies. This approach only uses the hg-ssh script from the Mercurial core contrib.</li>
    <li>Manual configuration. You can set different directories for each repository which allows you to work with your existing webroot setup. However, you will need to manually add new repositories, since hg-ssh does not support adding new repositories remotely.</li>
</ul>
</li>
</ul>
If you want a private version of Bitbucket (without any additional features, of course), e.g.  to be able to remotely init/clone new repositories, <a href="http://blog.mixu.net/2010/10/04/setting-up-private-ssh-based-mercurial-repo-hosting-on-centos/">check out my other tutorial about setting up private repo hosting</a>.</p>
<h2 id="1-make-sure-that-the-hg-directories-are-never-served-to-the-public">1. Make sure that the .hg directories are never served to the public</h2>
<p>To prevent .hg directories from being accessible to other people, you can take a number of (optional, but recommended) precautions:</p>
<p><strong>Move the web root of your project to a different folder</strong></p>
<p>You can probably alter your project  repository so that you have an explicit webroot folder in which you only have the files that should be accessible to the public (bootstrap + js/css resources). This makes it less likely that you accidentally serve your .hg directory. You move the files within hg do this using hg move:</p>
<pre class="hljs"><code><span class="hljs-built_in">mkdir</span> webroot
hg <span class="hljs-keyword">move</span> . webroot</code></pre><p>Or you can use hg addremove --similarity=100 after moving the files manually. It will detect identical files as moved.</p>
<p>After this, you may need to update your apache config to serve from the webroot (e.g. adjust the DocumentRoot directive for the site / virtual host).</p>
<p><strong>Set up Apache not to serve .hg directories</strong></p>
<p>You can also prevent Apache from serving directories with .hg in them by adding the following to your httpd.conf:</p>
<pre class="hljs"><code><span class="hljs-subst">&amp;</span><span class="hljs-literal">lt</span>;DirectoryMatch <span class="hljs-built_in">.</span>hg<span class="hljs-subst">&amp;</span><span class="hljs-literal">gt</span>;
   <span class="hljs-keyword">Order</span> allow,deny
   Deny from <span class="hljs-literal">all</span>
<span class="hljs-subst">&amp;</span><span class="hljs-literal">lt</span>;/DirectoryMatch<span class="hljs-subst">&amp;</span><span class="hljs-literal">gt</span>;</code></pre><p>Restart Apache if you change httpd.conf.</p>
<h2 id="2-setup-the-server">2. Setup the server</h2>
<p><strong>Create the user</strong></p>
<pre class="hljs"><code><span class="hljs-comment"># make a system user (-r) with a home directory (-m)</span>
useradd -r -m hg
<span class="hljs-comment"># lock the user account</span>
usermod -<span class="hljs-constant">L </span>hg
&lt;span style=<span class="hljs-string">&quot;font-family: Georgia, &#39;Times New Roman&#39;, &#39;Bitstream Charter&#39;, Times, serif; line-height: 19px; white-space: normal; font-size: 13px;&quot;</span>&gt;[<span class="hljs-regexp">/codesyntax]&lt;/span</span>&gt;</code></pre><p><strong>Setup ssh</strong></p>
<pre class="hljs"><code>#install mercurial <span class="hljs-keyword">if</span> not previously installed
yum install mercurial
su hg
cd <span class="hljs-regexp">/home/</span>hg/
wget <span class="hljs-string">http:</span><span class="hljs-comment">//www.selenic.com/repo/hg-stable/raw-file/tip/contrib/hg-ssh</span>
chmod u+x ~hg/hg-ssh
mkdir <span class="hljs-regexp">/home/</span>hg<span class="hljs-regexp">/.ssh/</span>
nano <span class="hljs-regexp">/home/</span>hg<span class="hljs-regexp">/.ssh/</span>authorized_keys
# remember to chmod the ssh config
chmod -R <span class="hljs-number">0700</span> <span class="hljs-regexp">/home/</span>hg<span class="hljs-regexp">/.ssh/</span></code></pre><p>Copy the public key: ssh-rsa ...(key data)== to /home/hg/.ssh/authorized_keys, one line for each authorized key.</p>
<p>Add the following in front of each authorized key in /home/hg/.ssh/authorized_keys:</p>
<pre class="hljs"><code>command=<span class="hljs-string">&quot;~hg/hg-ssh /path/to/repository&quot;</span>,no-port-forwarding,no-X11-forwarding,no-agent-forwarding ssh-rsa <span class="hljs-keyword">...</span>==</code></pre><p>If necessary, enable public key auth in /etc/ssh/sshd_config and add hg to the AllowUsers directive. Restart sshd if you change sshd_config.</p>
<h2 id="3-init-the-repo">3. Init the repo</h2>
<p><strong>New repo on the remote server</strong></p>
<p>Just run hg init in the new repo folder, then hg clone it on your computer from the remote server:</p>
<pre class="hljs"><code><span class="hljs-title">hg</span> clone -v --<span class="hljs-built_in">debug</span> <span class="hljs-url">ssh://hg<span class="hljs-variable">@server</span>:port/path/to/repo</span></code></pre><p>The -v and --debug make the clone show more information about what is going on.</p>
<p><strong>From existing sources</strong></p>
<p>Unfortunately hg-ssh does not support the hg init/hg clone command remotely. If you have an existing repo, you have to copy it first to the repository directory on the server. Since there are many files to move, I recommend gzipping the whole directory before moving it, then unzipping on the server. Do a hg log and hg status to see that everything transferred correctly.</p>
<p><strong>Adding more repos</strong></p>
<p>To add more repositories, simply add another repository path (separated by a space) immediately after the first repo path in .ssh/authorized_keys, and either init a new repo or copy an existing repo.</p>
<h2 id="4-push-updates">4. Push updates</h2>
<p>After you have the same repository on both the server and locally, you can start pushing  stuff to the server:</p>
<pre class="hljs"><code>hg push <span class="hljs-symbol">ssh:</span>/<span class="hljs-regexp">/hg@server:port/path</span><span class="hljs-regexp">/relative/to</span><span class="hljs-regexp">/home/dir</span></code></pre><p>If your repo path is not relative to the home dir, you need an extra slash in front of the push:</p>
<pre class="hljs"><code>hg push <span class="hljs-symbol">ssh:</span>/<span class="hljs-regexp">/hg@server:port/</span><span class="hljs-regexp">/path/relative</span><span class="hljs-regexp">/to/base</span><span class="hljs-regexp">/dir</span></code></pre><p>If you run into problems, try connecting via ssh - <a href="http://blog.mixu.net/2010/10/04/setting-up-private-ssh-based-mercurial-repo-hosting-on-centos/">see my previous post for some tips on this</a>.</p>
<h2 id="5-automate-hg-update">5. Automate hg update</h2>
<p>You should automate hg update so that each push causes the repository to be updated automatically to the pushed version. You can automate hg update on the remote repo by adding the following to the remote .hg/hgrc:</p>
<pre class="hljs"><code>[hooks]
changegroup = hg <span class="hljs-operator"><span class="hljs-keyword">update</span> &amp;gt;</span>&amp;amp;2</code></pre><p>Note that output has to be redirected to stderr (or /dev/null), because stdout is used for the data stream -which is why there is the &gt;&amp;2 at the end of the command.</p>
<p>If you get errors in updating automatically, check the permissions. In particular, make sure that .hg/ is owned by hg and that the content is readable by apache.</p>
<h2 id="6-set-up-default-push-or-create-an-alias">6. Set up default push or create an alias</h2>
<p>If you only push to one location, then you can set up the default locations for pull and push in the local  .hg/hgrc:</p>
<pre class="hljs"><code>[paths]
<span class="hljs-keyword">default</span> = ssh:<span class="hljs-comment">//hg@servername/reponame</span>
<span class="hljs-keyword">default</span>-<span class="hljs-keyword">push</span> = ssh<span class="hljs-comment">//:hg@servername/reponame</span></code></pre><p>This allows you to simply use &quot;hg push&quot; to deploy.</p>
<p>If you need more than one push location, create an alias in the local  .hg/hgrc:</p>
<pre class="hljs"><code>[<span class="hljs-keyword">alias</span>]
deploy = push -v --debug <span class="hljs-symbol">ssh:</span>/<span class="hljs-regexp">/hg@server:port/path</span><span class="hljs-regexp">/to/repo</span></code></pre><p>This allows you use &quot;hg deploy&quot; as an alias for deploying.</p>
<h2 id="what-about-configuration-files-">What about configuration files?</h2>
<p>One simple solution is to use &quot;hg forget&quot; to forget them once you have deployed the configuration files. This means that hg will not track the configuration files, but will not delete them either.</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>