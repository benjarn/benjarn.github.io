<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Kohana 3 auth: sample implementation and documentation</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Kohana 3 auth: sample implementation and documentation">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Kohana 3 auth: sample implementation and documentation">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2010/09/14/kohana-3-auth-sample-implementation-and-documentation.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2010/09/14/kohana-3-auth-sample-implementation-and-documentation.html" itemprop="url">Kohana 3 auth: sample implementation and documentation</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2010-09-14" itemprop="datePublished">September 14, 2010</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>This is the 3rd part of my mini-series on Kohana 3 auth. I figure the best way to show the Kohana Auth module works is to provide a sample application module which uses auth. In this series of posts, I discuss:</p>
<p><ol>
    <li><a href="http://blog.mixu.net/2010/09/06/step-by-step-guide-to-kohana-3-auth/">Setting up the basic Auth in KO3</a> (part 1)</li>
    <li><a href="http://blog.mixu.net/2010/09/07/kohana-3-auth-the-auth-module-functionality/">An overview of the functionality provided by the Auth module</a> (part 2)</li>
    <li>Tips on implementing Auth in a custom application (part 3; this part)</li>
    <li><a href="http://blog.mixu.net/2011/01/13/getting-started-with-useradmin-my-kohana-3-auth-admin-module/">Getting started with Useradmin, my Kohana 3 auth admin module</a> (part 4)</li>
</ol></p>
<p><h3>The new release is AWESOME :), and now is based on the Kohana 3.1.x API. (You can get the old version for 3.0.x via Github.)</h3>
Here are a few screenshots:</p>
<p><span style="font-size: 13px; font-weight: normal;"><a href="http://blog.mixu.net/files/2010/09/useradmin-screen.png"><img class="alignnone size-full wp-image-1835" title="useradmin-screen" src="http://blog.mixu.net/files/2010/09/useradmin-screen.png" alt="" width="480" height="360" /></a>
</span></p>
<p><strong>New UI, more providers supported!</strong> Get it from:</p>
<p><ul>
    <li>Github: <a href="https://github.com/mixu/useradmin">https://github.com/mixu/useradmin
</a>(git clone git://github.com/mixu/useradmin.git)</li>
</ul>
This is a custom module, and the code is in /modules/user. The code contains way more comments than usual. I&#39;ve tried to make things clear, and keep the UI basic but pretty enough.</p>
<p>Further, the code is released under the BSD licence, so you can use it in commercial applications. While I don&#39;t restrict you in using the code, it is good karma to send improvements to this module back: in particular, I would like to have the features in the roadmap below.</p>
<p><strong>What functionality is there:</strong></p>
<p><ul>
    <li>Use the base Ko3 auth module and do not reinvent the wheel -- OK</li>
    <li>Support translation; no strings without __() -- OK</li>
    <li>Boilerplate for administration (create user, edit user, delete user, list users and last logins) -- OK; roles have to be added via DB but that&#39;s OK</li>
    <li>Boilerplate for users (login, logout, view profile, edit profile, unregister, access denied page; error handling/validation) -- OK</li>
    <li>reCAPTCHA optionally supported for registration -- OK; implemented for registration, thank you <a href="https://bitbucket.org/jnbdz/useradmin/">jnbdz</a>!</li>
    <li>Optional support for 3rd party login:</p>
<p><ul>
    <li>Facebook -- OK</li>
    <li>Google -- OK</li>
    <li>Yahoo -- OK</li>
    <li>Twitter -- OK (with the caveat that Twitter does not allow you to get the email address via api)</li>
</ul>
</li>
    <li>Login  using username, email or both -- OK</li>
    <li>Optional lost password reset via email -- OK; workflow is a bit clunky (user has to type the new password one time)</li>
    <li>Optional autologin support via cookies -- OK but not documented here; read about it Ko3 docs. Need to add checkbox to UI.</li>
    <li>Optional enforcement of number of failed login attempts -- is there but configuration/activation is clunky.</li>
    <li>UI design that doesn&#39;t make your eyes bleed -- OK</li>
    <li>Kohana 3.1.x support - OK, thank you gartz!</li>
</ul>
<strong>What needs to be done - contribute this!</strong></p>
<p><ul>
    <li>reCAPTCHA optionally supported for too many failed logins</li>
    <li>Optional account activation via confirmation email + expire unactivated account/welcome message via email</li>
    <li>Optional password strength indicator for client</li>
    <li>Separation between module and sample app on Github -- e.g. migrate development to Github only</li>
</ul>
<strong>Nice-to-have</strong> (perhaps release as compatible modules?)</p>
<p><ul>
    <li>Profile picture loading from Facebook, Twitter or uploaded image -- not yet.</li>
</ul>
So if you implement any of those, and don&#39;t it to be too much of a burden to publish them under the BSD licence, let me know via comments or via email (firstname.surname@gmail.com).</p>
<p><strong>Changelog is in the readme file on Github/Bitbucket.</strong></p>
<p><h2>Useful code snippets</h2>
Here are some code snippets which show you the basics of Auth:</p>
<p><strong>Create a new user</strong> (e.g. if you have not set up any users yet and want to do that programmatically)</p>
<pre class="hljs"><code><span class="hljs-variable">$model</span> <span class="hljs-subst">=</span> ORM<span class="hljs-tag">::factory</span>(<span class="hljs-string">&#39;user&#39;</span>);
<span class="hljs-variable">$model</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;values(<span class="hljs-built_in">array</span>(
   <span class="hljs-string">&#39;username&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;admin&#39;</span>,
   <span class="hljs-string">&#39;email&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;admin@example.com&#39;</span>,
   <span class="hljs-string">&#39;password&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;admin&#39;</span>,
   <span class="hljs-string">&#39;password_confirm&#39;</span> <span class="hljs-subst">=&amp;</span><span class="hljs-literal">gt</span>; <span class="hljs-string">&#39;admin&#39;</span>,
));
<span class="hljs-variable">$model</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;save();
<span class="hljs-comment">// remember to add the login role AND the admin role</span>
<span class="hljs-comment">// add a role; add() executes the query immediately</span>
<span class="hljs-variable">$model</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;add(<span class="hljs-string">&#39;roles&#39;</span>, ORM<span class="hljs-tag">::factory</span>(<span class="hljs-string">&#39;role&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;<span class="hljs-keyword">where</span>(<span class="hljs-string">&#39;name&#39;</span>, <span class="hljs-string">&#39;=&#39;</span>, <span class="hljs-string">&#39;login&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;find());
<span class="hljs-variable">$model</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;add(<span class="hljs-string">&#39;roles&#39;</span>, ORM<span class="hljs-tag">::factory</span>(<span class="hljs-string">&#39;role&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;<span class="hljs-keyword">where</span>(<span class="hljs-string">&#39;name&#39;</span>, <span class="hljs-string">&#39;=&#39;</span>, <span class="hljs-string">&#39;admin&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;find());</code></pre><p><strong>Check whether current user has a role</strong></p>
<pre class="hljs"><code>Auth<span class="hljs-tag">::instance</span>()<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;logged_in(<span class="hljs-string">&#39;admin&#39;</span>) <span class="hljs-comment">// for current user</span>
<span class="hljs-subst">&lt;</span>span style<span class="hljs-subst">=</span><span class="hljs-string">&quot;font-family: Georgia, &#39;Times New Roman&#39;, &#39;Bitstream Charter&#39;, Times, serif; line-height: 19px; white-space: normal; font-size: 13px;&quot;</span><span class="hljs-subst">&gt;</span><span class="hljs-preprocessor">[</span>/codesyntax<span class="hljs-preprocessor">]</span><span class="hljs-markup">&lt;/span&gt;</span></code></pre><p><strong>Check whether some other user has a role</strong></p>
<pre class="hljs"><code>// <span class="hljs-operator"><span class="hljs-keyword">Load</span> the role
$role = ORM::factory(<span class="hljs-string">&#39;role&#39;</span>, <span class="hljs-built_in">array</span>(<span class="hljs-string">&#39;name&#39;</span> =&amp;gt;</span> &#39;admin));
// <span class="hljs-operator"><span class="hljs-keyword">Check</span> that the <span class="hljs-keyword">user</span> has the given role
$<span class="hljs-keyword">status</span> = $<span class="hljs-keyword">user</span>-&amp;gt;</span>has(&#39;roles&#39;, $role);</code></pre><p><strong>Add a role to a user</strong></p>
<pre class="hljs"><code><span class="hljs-comment">// add() executes the query immediately, and saves the data (unlike the KO2 docs say)</span>
<span class="hljs-variable">$user</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;add(<span class="hljs-string">&#39;roles&#39;</span>, ORM<span class="hljs-tag">::factory</span>(<span class="hljs-string">&#39;role&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;<span class="hljs-keyword">where</span>(<span class="hljs-string">&#39;name&#39;</span>, <span class="hljs-string">&#39;=&#39;</span>, <span class="hljs-string">&#39;admin&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;find());</code></pre><p><strong>Remove a role from a user</strong></p>
<pre class="hljs"><code><span class="hljs-comment">// remove() executes the query immediately</span>
<span class="hljs-variable">$user</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;remove(<span class="hljs-string">&#39;roles&#39;</span>, ORM<span class="hljs-tag">::factory</span>(<span class="hljs-string">&#39;role&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;<span class="hljs-keyword">where</span>(<span class="hljs-string">&#39;name&#39;</span>, <span class="hljs-string">&#39;=&#39;</span>, <span class="hljs-string">&#39;admin&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;find());</code></pre><p><strong>Retrieve all users that have a particular role</strong></p>
<pre class="hljs"><code><span class="hljs-comment">// find all the reviewer users in order of their username</span>
<span class="hljs-variable">$role</span> <span class="hljs-subst">=</span> ORM<span class="hljs-tag">::factory</span>(<span class="hljs-string">&#39;role&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;<span class="hljs-keyword">where</span>(<span class="hljs-string">&#39;name&#39;</span>, <span class="hljs-string">&#39;=&#39;</span>, <span class="hljs-string">&#39;reviewer&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;find();
<span class="hljs-variable">$users</span> <span class="hljs-subst">=</span> <span class="hljs-variable">$role</span><span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;users<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;order_by(<span class="hljs-string">&#39;username&#39;</span>, <span class="hljs-string">&#39;DESC&#39;</span>)<span class="hljs-subst">-&amp;</span><span class="hljs-literal">gt</span>;find_all();
foreach(<span class="hljs-variable">$users</span> as <span class="hljs-variable">$user</span>) {<span class="hljs-attribute">...</span>}</code></pre><p><h2>Documentation on the interesting bits</h2></p>
<p><h3>The template view</h3>
The template view in /views/default/template.php uses the Thematic-inspired markup which I discuss in <a href="http://blog.mixu.net/2010/07/20/better-web-application-interface-markup-lessons-from-theme-frameworks/">this post</a>. You can do a lot by adding a few more divs into the header div. I have tried to follow <a href="http://blog.mixu.net/2010/03/15/7-additional-tips-for-css-markup/">my own advice about CSS</a>, but the included CSS file is pretty basic. It includes the Yahoo CSS reset.</p>
<p><h3>Controller_App: base controller class</h3>
This is the &quot;base&quot; controller I use for all the classes. It handles template autoloading and auth checks. You should inherit all your controllers from Controller_App to benefit from its features.</p>
<p>There is also one additional neat thing: in case of session expiry, Kohana may show an error in session loading. There is an additional check for this in Controller_App, which discards the session in case of loading errors.</p>
<p>Template autoloading loads the file from /views/default/template.php, so that you just have to set $this-&gt;template-&gt;content = $view-&gt;render() in your controller.</p>
<p>Auth checks are configured through two additional properties in the controller:</p>
<pre class="hljs"><code>/<strong>
 <em> Controls access <span class="hljs-keyword">for</span> the whole controller, <span class="hljs-keyword">if</span> not <span class="hljs-keyword">set</span> <span class="hljs-keyword">to</span>
FALSE we will <span class="hljs-keyword">only</span> allow user roles specified.
 </em>
 <em> See Controller_App <span class="hljs-keyword">for</span> how this implemented.
 </em>
 <em> Can <span class="hljs-keyword">be</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">string</span> <span class="hljs-built_in">or</span> <span class="hljs-keyword">an</span> array, <span class="hljs-keyword">for</span> example array(<span class="hljs-string">&#39;login&#39;</span>, <span class="hljs-string">&#39;admin&#39;</span>) <span class="hljs-built_in">or</span> <span class="hljs-string">&#39;login&#39;</span>
 </em>/
public $auth_required = FALSE;

/</strong> Controls access <span class="hljs-keyword">for</span> separate actions
 <em>
 </em>  See Controller_App <span class="hljs-keyword">for</span> how this implemented.
 <em>
 </em>  Example<span class="hljs-variable">s:</span>
 * <span class="hljs-string">&#39;adminpanel&#39;</span> =&amp;gt; <span class="hljs-string">&#39;admin&#39;</span> will <span class="hljs-keyword">only</span> allow users with</code></pre><h2 id="comments">Comments</h2>
<p><strong><a href="#130" title="2010-09-25 02:05:58">Glenn Bennett</a>:</strong> Wow...thanks so much. I have an application that&#39;s I&#39;m using that I didn&#39;t write and the user management was missing and it in process of dinking around with the database I kinda messed thing up a bit.</p>
<p>Long story short(er) I found your article here and added domain management pretty easily by just installing your whole sample then hooking to the other database and with a few tweeks here and there I created a user management app for my application.</p>
<p>Thanks so much...great work.</p>
<p>P.S. Kohana drives me nuts.</p>
<p><strong><a href="#131" title="2010-10-15 08:03:54">Yuzhou Zhu</a>:</strong> When I check out the source code, I cannot find the files related to this tutorial, only a welcome.php in the controller folder. Am I missing something here?</p>
<p><strong><a href="#132" title="2010-10-15 08:25:31">Mikito Takada</a>:</strong> The auth implementation is a module, so the files are in the modules/user/ directory, not under app/.</p>
<p>This is useful because if you already have an app, you can just copy the modules/user/ folder and enable it in bootstrap.php (before loading the core Auth module). Also, you can extend the module using the Kohana 3 HMVC mechanism by redefining e.g. the user model in app/models/.</p>
<p><strong><a href="#133" title="2010-10-28 13:05:23">Peter Weil</a>:</strong> Mikito, thanks so much for this module! One issue that I&#39;m initially running into: when I go to edit a user to say, change the role,, I get this error:</p>
<p>&quot;Invalid method validate_edit called in Model_User&quot;</p>
<p>(this is the call from  line 88 in Controller_Admin_User)</p>
<p>But this very method-- validate_edit() -- is right there in Model_User. I&#39;m still trying to figure out why I&#39;m getting this error.</p>
<p><strong><a href="#134" title="2010-10-28 13:28:26">Mikito Takada</a>:</strong> Thanks for the feedback!</p>
<p>Editing user roles works using the unmodified repo. Do you happen to have a file named /application/classes/model/user.php?</p>
<p>Kohana&#39;s HMVC will use that file instead of /modules/user/classes/model/user.php if you do, so you need to copy the extra functions there - and associations... from the modules directory model when you start writing your own User model.</p>
<p><strong><a href="#135" title="2010-10-28 13:40:10">Peter Weil</a>:</strong> The <em>was</em> another Model_User class -- in the auth module. I just found the answer in the Kohana forums:  the user module has to be loaded before the auth module:</p>
<p><a href="http://forum.kohanaframework.org/discussion/comment/41585/#Comment_41585">http://forum.kohanaframework.org/discussion/comment/41585/#Comment_41585</a></p>
<p>Thanks!</p>
<p><strong><a href="#136" title="2010-11-03 16:08:14">Robert Van Sant</a>:</strong> Thanks so much for this explanation and code sample.  Sometimes I feel Kohana is great and sometimes I feel like why isn&#39;t it easier like CodeIgniter.  I definitely like that it&#39;s strict PHP5 coding, hence why I&#39;m trying very hard to learn the nuances of the Kohana framework.  I have a question in terms of templating and Ajax.  What is the best route to handle this.  Is it a matter of returning the rendered blocks as a response and using a replace JavaScript function to replace that HTML block?  I&#39;ve done this before with other projects.</p>
<p>Thanks in advance for any advice.</p>
<p><strong><a href="#137" title="2010-11-11 10:55:46">Kyuo</a>:</strong> Thanks for this great tutorial! I&#39;m new with user-management, but I see in another user-manager a &quot;Session Manager&quot; with a session database table, here I not understand to handling the sessions. Is this session-table not necessary?</p>
<p>In this time there is no data for &quot;user is online&quot; or &quot;user is offline since ???&quot; or a list of online users. Coming this in a next tutorial? :)</p>
<p><strong><a href="#138" title="2010-11-11 11:12:48">Mikito Takada</a>:</strong> If you want to implement this, there are basically two additional things you need to do:</p>
<p>1: keep track of when the user was last active (e.g. on each page load, update a value somewhere in the database)</p>
<p>2: show users as online if they were active within the last x minutes (e.g. a page load occurred in the last 15 minutes)</p>
<p>Sessions do no need any tables, they are a core functionality of PHP, see <a href="http://www.php.net/manual/en/function.session-start.php">http://www.php.net/manual/en/function.session-start.php</a> and are not stored in the database.</p>
<p>You can keep track of sessions in a table if you want to show other people whether a user is online. However, my focus here is on Auth and user account management, so the I only keep track of the last login (you can see that in the admin interface).</p>
<p>If you want to track user activity, you need to write the additional tracking yourself.</p>
<p><strong><a href="#141" title="2010-11-12 20:51:56">Pedro Sland</a>:</strong> I&#39;ve looked into some of the possabilities myself and I have decided that the best is to use json_encode(array(--vars here--)); For another project I simply wrote a simple array to xml class instead.</p>
<p>If you are using a template controller you will need to do something there not to get the header and footer.</p>
<p><strong><a href="#142" title="2010-11-24 01:54:21">flurry</a>:</strong> hey mikito,</p>
<p>thanks for this realy nice backend and tutorial.
it runs verry well with my kohana 3.0.8 except the
$user-&gt;reset_token function is missing. is this a known bug, or is this a configuration problem from myself?
i will add an additional functionality for validating an email adress by the user after registration, when i have time again.</p>
<p><strong><a href="#143" title="2010-11-25 11:14:15">Mikito Takada</a>:</strong> Hi,</p>
<p>Yes, this is a known problem. I will update the repository with new KO3.0.8 compatible code, the improved schema, plus some added niceties soon.</p>
<p><strong><a href="#144" title="2010-11-25 19:54:49">flurry</a>:</strong> hey,</p>
<p>thanks for the reply. i&#39;m curious about it.</p>
<p><strong><a href="#145" title="2010-12-02 23:18:36">Ralph</a>:</strong> Am I missing something?  I downloaded the source, but the &#39;application/classes/controller&#39; folder is empty aside from a default welcome.php file.  Where are all the controller class files?</p>
<p><strong><a href="#146" title="2010-12-02 23:22:21">Ralph</a>:</strong> Oh wait, talking to myself here--I guess they are in modules/user/</p>
<p><strong><a href="#148" title="2010-12-19 01:22:24">michael</a>:</strong> Hi,
I read your tutorial, which I mainly understand( I think ), but there is one thing that I dont understand, (i am new to Kohana), I thought that you needed to load your module in bootsrap, but I have searched, and havent seen where you did it...</p>
<p>I want to develop a module myself so i was wondering...</p>
<p><strong><a href="#149" title="2010-12-19 01:27:55">Mikito Takada</a>:</strong> Hi,</p>
<p>See <a href="https://bitbucket.org/mixu/useradmin/src/f13a6dc8386d/application/bootstrap.php">https://bitbucket.org/mixu/useradmin/src/f13a6dc8386d/application/bootstrap.php</a> line 80. The module is actually called &quot;user&quot; for now, which reminds me that I should change that to &quot;useradmin&quot; next time I publish an update..</p>
<p><strong><a href="#150" title="2010-12-19 01:32:46">michael</a>:</strong> I just found it, but i was going crazy. I thought i didnt understand.</p>
<p>It just &quot;appeared&quot; because I thought that it was added at the end of the modules list...
But thanks for you fast answer!</p>
<p><strong><a href="#151" title="2010-12-19 01:48:52">michael</a>:</strong> I have another question thought, Why do we need to load the user module before the auth module?</p>
<p>I tried to do a module on my own and &quot;discovered&quot; that it automatically hashed the password...</p>
<p><strong><a href="#152" title="2010-12-19 02:56:12">Mikito Takada</a>:</strong> Module loading order matters because the useradmin module is extending Model_Auth_User.</p>
<p>Otherwise, Kohana will use the barebones user model from:</p>
<p>modules/auth/classes/model/user.php</p>
<p>instead of:</p>
<p>modules/user/classes/model/user.php</p>
<p>If you prefer, you can just copy modules/user/classes/model/user.php to application/classes/model/user.php; then the loading order won&#39;t matter.</p>
<p>Full explanation: <a href="http://kohanaframework.org/guide/about.filesystem">http://kohanaframework.org/guide/about.filesystem</a> and <a href="http://kohanaframework.org/guide/about.flow">http://kohanaframework.org/guide/about.flow</a></p>
<p><strong><a href="#153" title="2010-12-20 21:55:03">Jason</a>:</strong> Oh my god! THANK YOU, I am getting into Kohana and well the most buggery thing is the auth and user controls with roles :D so you have just saved me a arm and a leg and allow me to get knowing kohana from the heart of what i require todo :D</p>
<p>10/10</p>
<p><strong><a href="#155" title="2011-01-20 11:41:32">anton</a>:</strong> Hello Mikito!
I learned your class Model_Useradmin_User and there&#39;s area that i can&#39;t understand.
In method login() you call:
if ($this-&gt;loaded() AND Auth::instance()-&gt;login($this, $array[&#39;password&#39;])) {....
but
Auth::login(...){
...
$this-&gt;_login($username, $password, $remember);
...
}
and _login is abstract method which have to be defined for user.
I tried to find subclass Auth where this and other two abstract method have to be defined but i couldn&#39;t find it. Please help my investigate it.</p>
<p><strong><a href="#156" title="2011-01-20 11:51:00">Mikito Takada</a>:</strong> Hi Anton,</p>
<p>I am using the KO3 core Auth class. And as you can see in /modules/auth/classes /kohana/auth.php function instance(), the actual class is determined by configuration.</p>
<p>Auth can be configured at application/config/auth.php to either use the ORM driver or file driver. The default, and the one I test with is the ORM driver.</p>
<p>The concrete code for login() that is located in /modules/auth/classes/ kohana/auth/orm.php . Note that this is all KO3 core code.</p>
<p><strong><a href="#157" title="2011-01-20 13:33:05">anton</a>:</strong> Ok. I find it. Thank y for halp.</p>
<p><strong><a href="#158" title="2011-01-20 14:12:21">anton</a>:</strong> I have some question about your model. Why did y not write logged_in method and other like Kohana_Auth? Or do y think it&#39;s bad idea and need use Auth::logged_in method in controllers?</p>
<p><strong><a href="#159" title="2011-01-20 14:17:00">anton</a>:</strong> Is it good idea write wrapper Kohana_Auth_Orm::logged_in() method?</p>
<p><strong><a href="#160" title="2011-01-21 23:56:08">Mikito Takada</a>:</strong> Hi,</p>
<p>not sure I understand your question. I&#39;m not writing any wrappers for Auth, because I am not trying to replace the core Auth functionality - I just want to build a module that uses KO3 Core Auth and adds the most commonly used functionality. So I only use/inherit from Auth, and extend the base Auth_User model a little bit in my User model to provide password resets and validation for changing the password after registering.</p>
<p>Why should there be a wrapper for Auth::logged_in? What would be the benefit?</p>
<p><strong><a href="#162" title="2011-02-24 22:30:34">jim</a>:</strong> Hey, nice job you did there, Mikito! Are you going to update the module to work with the newest kohana version (3.1.1)? It would be great!</p>
<p><strong><a href="#163" title="2011-02-24 23:07:57">Mikito Takada</a>:</strong> I am going to release a rather big and awesome update soon with Twitter, Google and Yahoo support as well as a new UI, it&#39;ll be out very soon (a couple of days?).</p>
<p>I will update to 3.1.x at some point, but not immediately as I am swamped with other work and the 3.0.x branch is still working perfectly fine (and is still supported).
Looking at <a href="http://forum.kohanaframework.org/discussion/7793/kohana-3.0-to-3.1-upgrade-troubleshooting">http://forum.kohanaframework.org/discussion/7793/kohana-3.0-to-3.1-upgrade-troubleshooting</a> there are quite a few things to test/debug etc. The main issue is that KO 3.0.x Auth hashes aren&#39;t supported on 3.1.x and I don&#39;t have the time to figure out the migration right now.</p>
<p>Please give it a try yourself if you need to have KO 3.1.x support quickly.</p>
<p><strong><a href="#164" title="2011-02-25 00:13:46">jim</a>:</strong> Can&#39;t wait :) Hope you get it done quick.</p>
<p><strong><a href="#165" title="2011-03-17 08:35:13">anang</a>:</strong> Hi,
Finally I can make your module works for Ko3.1.
I&#39;m not a good coder, and my kohana exprience is minimal, so I don&#39;t know whether my modification is the proper one.</p>
<p>The modification is 1-4 lines per function, except for action_profile_edit, I made a lot of changes.</p>
<p>not sure where to put my code, just ask me I&#39;ll email to who interested.</p>
<p><strong><a href="#166" title="2011-03-17 10:28:37">Mikito Takada</a>:</strong> Hi Anang - send me the code, I&#39;ll merge and publish it on Github. My email is in the form: (firstname).(surname)@gmail.com...</p>
<p><strong><a href="#167" title="2011-04-24 18:45:11">Joe Dwyer</a>:</strong> Mikito, thanks for building and sharing such a great module!</p>
<p>At first I ran into an issue because the driver (stupid me) was set to &quot;File&quot; and needed to be set to &quot;ORM&quot;. That was easy to fix.</p>
<p>Then, it expected the pagination module, which was also pretty easy to add.</p>
<p>Now I&#39;m getting an error saying that &quot;The user_identity property does not exist in the Model_User class&quot;. It looks like that&#39;s related to the outside user identities (Facebook, Google, etc.). Is there a swing table it&#39;s looking for or something? Anything else I need to do to set that up?</p>
<p>Thanks in advance for the help!</p>
<p><strong><a href="#168" title="2011-04-24 18:58:53">Mikito Takada</a>:</strong> Great!</p>
<p>You are probably loading the modules in the wrong order - so the Auth module Model_User is being used instead of the Useradmin module Model_User. The Auth version of Model_User does not have the additional relationships. Recheck your module loading order in bootstrap.php. More info in the &quot;Getting Started with Useradmin&quot; post: <a href="http://blog.mixu.net/2011/01/13/getting-started-with-useradmin-my-kohana-3-auth-admin-module/">http://blog.mixu.net/2011/01/13/getting-started-with-useradmin-my-kohana-3-auth-admin-module/</a></p>
<p>Also, make sure you have the database structure from the SQL file in the module directory (foreign key constraints are not important if it complains about those).</p>
<p>Reading about your troubles reminds me that I should offer a &quot;ready to go&quot; version as well. There used to be one, but heavy Git/Github users prefer pure modules over full applications...</p>
<p><strong><a href="#169" title="2011-04-24 19:12:10">Joe Dwyer</a>:</strong> Mikito! You are awesome! Thanks for the quick response. Looks like it&#39;s working now.</p>
<p>I understand users wanting pure modules, but I agree it&#39;s nice to have a fully &quot;ready to go&quot; version for people who are learning Kohana. It&#39;s much easier to throw something up, see that it works, and then start tweaking. When the tweaks break something... it&#39;s pretty easy to figure out what happened. But when you can&#39;t get it to work in the first place, it&#39;s much harder to figure out where the error is. After I get more used to Kohana, I suspect that won&#39;t be as much of an issue, though...</p>
<p>Have a great weekend!</p>
<p><strong><a href="#170" title="2011-04-25 15:06:49">John Rushworth</a>:</strong> You have my undying love and gratitude. This is awesome!!! Exactly what was needed at exactly the right time. Thank-you very much for a GREAT job, stunningly executed. I had a few minor issues... not sure if they are typical or not... like user.last_failed_login and user.modified needing default values.... but this was as painless as it comes... and it does EXACTLY what it said on the box. Thanks again. Many karmic hugs.</p>
<p><strong><a href="#171" title="2011-06-12 23:47:17">anon</a>:</strong> I have done everything described above but I am getting 404 error when I want to see x/user/login. &#39;x&#39; is my base url. I cant understand why my default route does not catch the uri. I have declared the user module before the auth module.
My default route is:
...
Route::set(&#39;x/user&#39;, &#39;user(/(/))&#39;)
    -&gt;defaults(array(
        &#39;controller&#39; =&gt; &#39;user&#39;,
        &#39;action&#39; =&gt; &#39;index&#39;,
        &#39;id&#39; =&gt; NULL,
));
Route::set(&#39;default&#39;, &#39;((/(/)))&#39;)
    -&gt;defaults(array(
        &#39;controller&#39; =&gt; &#39;main&#39;,
        &#39;action&#39;     =&gt; &#39;index&#39;,
    ));</p>
<p><strong><a href="#172" title="2011-06-28 23:52:46">Guidouil</a>:</strong> Great Job, using it for my project and loving it :D
There is jeust a little challenge regarding the auto_login part with a cookie, as you say the kohana auth module handle it very well but there is a little problem with your database. The token field in the user_tokens table should be a varchar(40) and not 32.
It now works better for me ^^
Thank you very much once again, keep up enhancing the stuff, I&#39;m planning to fork it sometime ;)</p>
<p><strong><a href="#173" title="2011-10-30 15:07:34">Craig</a>:</strong> Hi I&#39;m trying to find the folder /modules/user in the github repository as mentioned in the post but I cannot seem to see this folder.</p>
<p>Can anyone give me any pointers where this module is?</p>
<p>Thanks in advance</p>
<p><strong><a href="#174" title="2011-12-18 00:10:36">Daniel Iser</a>:</strong> Here&#39;s the way I worked out for apps with heavy Ajax usage. Rather than having to duplicate a lot of actions I set my main controller to detect if it was an Ajax request. If it was set the template to an json encoded output.</p>
<p>In my actions I prepare all values into the same variables for each $values, $errors, $messages etc.</p>
<p>The Json view combines $values, $errors and $messages into a single array and runs it through json_encode and prints it.</p>
<p>Doing it this way you have less code to write and it&#39;s easier to maintain when you have to make changes.</p>
<p><strong><a href="#175" title="2012-01-26 20:36:54">Anuruddha</a>:</strong> Hi, I am a newbie to Kohana, and was trying to setup this as my starting point. I&#39;ve downloaded the code from github, but wasn&#39;t successful in getting this running in my local. Is there any documentation about how to set this up? Or would you be able to give me the steps required for setting the code?
Thanks A LOT in advance!</p>
<p><strong><a href="#176" title="2012-03-08 22:23:46">Casper</a>:</strong> @Guidouil, thank you so much for your comment.</p>
<p><strong><a href="#177" title="2012-03-29 18:40:42">iPoul</a>:</strong> Hi, i was wondering if its possible to use the Auth Module without the use of roles ? or am i bound to use them, unless i want to rewrite the module or make my own ?</p>
<p>Kind regards, iPoul</p>
<p><strong><a href="#178" title="2012-05-19 17:17:51">Bojan</a>:</strong> Hi, I&#39;m having the same problem as Joe Dwyer, but my bootstrap is fine I think.</p>
<p>The user_identity property does not exist in the Model_User class</p>
<p>The problem is when I use pagination (admin_user).</p>
<p>Kohana::modules(array(
    &#39;useradmin&#39; =&gt; MODPATH . &#39;useradmin&#39;, // Mixu&#39;s useradmin module
    &#39;auth&#39; =&gt; MODPATH . &#39;auth&#39;, // Basic authentication
multiple backends
    &#39;database&#39; =&gt; MODPATH . &#39;database&#39;, // Database access
    &#39;orm&#39; =&gt; MODPATH . &#39;orm&#39;, // Object Relationship Mapping
    &#39;pagination&#39; =&gt; MODPATH . &#39;pagination&#39;, // pagination
));</p>
<p>&quot;Ready to go&quot; would be awesome!</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>