<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Performance benchmarking Socket.io 0.8.7, 0.7.11 and 0.6.17 and Node&#x27;s native TCP</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Performance benchmarking Socket.io 0.8.7, 0.7.11 and 0.6.17 and Node&#x27;s native TCP">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Performance benchmarking Socket.io 0.8.7, 0.7.11 and 0.6.17 and Node&#x27;s native TCP">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2011/11/22/performance-benchmarking-socket-io-0-8-7-0-7-11-and-0-6-17-and-nodes-native-tcp.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2011/11/22/performance-benchmarking-socket-io-0-8-7-0-7-11-and-0-6-17-and-nodes-native-tcp.html" itemprop="url">Performance benchmarking Socket.io 0.8.7, 0.7.11 and 0.6.17 and Node&#x27;s native TCP</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2011-11-22" itemprop="datePublished">November 22, 2011</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>I&#39;ve been working with Socket.io quite a bit recently. It&#39;s a great library. However, after upgrading to 0.8.x, I ran into problems with increased CPU usage. Since performance is very important for high traffic pubsub implementations, I decided to investigate this further - and try to quantify the performance impact of upgrading to a newer version of Socket.io.</p>
<p>I wrote a benchmarking suite (<a href="https://github.com/mixu/siobench">siobench</a>). The benchmark is rather simple. Clients connect one at a time, and a new client is only allowed to connect when the previous one is connected. When the server has used up 5000 milliseconds of CPU time, the benchmark is stopped. Every second, every connected client sends a single message which is echoed back by the server (<a href="https://github.com/mixu/siobench">more details</a>).</p>
<p>This workload is geared towards a situation where Socket.io is used to notify people of things as part of a larger application: e.g. most of the load is assumed to be idling connections rather than real-time messaging like in, say, a multiplayer game.</p>
<p>The &quot;end of test&quot; condition is 5000 ms of CPU time, because this seemed to be a easy way to give all implementations the same amount of time. CPU usage % is not accurate, since it is dependent on how much CPU time the process gets over a particular amount of wallclock time. In the graphs the CPU usage % calculated over a 100ms interval, while usertime and systime are the actual numbers reported at that particular time.</p>
<p><h2>Summary</h2></p>
<p><table></p>
<p><tbody></p>
<p><tr></p>
<p><td>Node (0.4.12) using tcp</td></p>
<p><td>~ 8000 connections on a single core</td>
</tr></p>
<p><tr></p>
<p><td>socket.io 0.6.17 using websockets</td></p>
<p><td>~ 2300 connections on a single core</td>
</tr></p>
<p><tr></p>
<p><td>socket.io 0.7.11 using websockets</td></p>
<p><td>~ 1800 connections on a single core</td>
</tr></p>
<p><tr></p>
<p><td>socket.io 0.8.6 using websockets</td></p>
<p><td>~ 1900 connections on a single core</td>
</tr>
</tbody>
</table>
Remember, this is just one server on one core, with 5000 ms of CPU time on that core. The rest of the cores are used to generate sufficient load. The full graphs are at the end of the post.</p>
<p>Note that the absolute numbers are mostly unimportant - I ran this on the following 15&quot; Macbook Pro running Arch with the 3.1.04 Linux kernel in Virtualbox with 4096 Mb of RAM, a SSD and four cores (Intel(R) Core(TM) i7-2635QM CPU @ 2.00GHz GenuineIntel GNU/Linux). You can get numbers that are more representative of your system <a href="https://github.com/mixu/siobench">by getting siobench</a> and running it:</p>
<pre class="hljs"><code><span class="hljs-string">Usage:</span> node siobench.js [env]
A tool <span class="hljs-keyword">for</span> benchmarking your Socket.io server.

Available <span class="hljs-string">environments:</span>
    <span class="hljs-number">0.6</span><span class="hljs-number">.17</span>
    <span class="hljs-number">0.6</span><span class="hljs-number">.17</span>_poll
    <span class="hljs-number">0.7</span><span class="hljs-number">.11</span>
    <span class="hljs-number">0.8</span><span class="hljs-number">.7</span>
    <span class="hljs-number">0.8</span><span class="hljs-number">.7</span>_poll
    tcp</code></pre><p>You can also write your own benchmarks under ./bench, by writing a new server.js (<a href="https://github.com/mixu/siobench/blob/master/bench/tcp/server_tcp.js">example #1</a>, <a href="https://github.com/mixu/siobench/blob/master/bench/sio087/server.js">#2</a>) and a new client.js (<a href="https://github.com/mixu/siobench/blob/master/bench/tcp/client_tcp.js">example #1</a>, <a href="https://github.com/mixu/siobench/blob/master/bench/sio087/client.js">#2</a>). Each benchmark has it&#39;s own set of npm dependencies installed, so that one can run benchmarks against many versions of socket.io.</p>
<p><strong>Some notes on performance</strong></p>
<p>The relative performance is more interesting.</p>
<p>First, the node TCP speed represents the highest achievable performance on this benchmark, since it only uses the built-in TCP implementation. Compared to this, Socket.io is has about 1/3 of the performance (~ 2300 vs ~8000 connections) when using WebSockets.</p>
<p>Second, it appears that 0.8.7 is about 20% slower than 0.6.17 on this benchmark. If I remember correctly, Socket.io 0.7 switched to a new protocol, and there are clearly some performance improvements over 0.7.11 in 0.8.7 (+100 connections in this bench); it&#39;s just that the overall performance is still worse in this benchmark than in the old 0.6.17 branch.</p>
<p><strong>Working towards higher-performance</strong></p>
<p>As this is just a simple benchmark, I don&#39;t really have solutions - only some suggestions.</p>
<p><strong>1) A CI build that includes benchmarks and community contributed test cases</strong></p>
<p>First, I&#39;d love to see a CI build for Socket.io that would include performance benchmarks and community contributed test cases.</p>
<p>However, currently setting up a CI build for Socket.io is difficult because <a href="https://github.com/LearnBoost/socket.io/issues/519">the bundled test suite only works on OSX</a>. It would be a lot easier to contribute if the tests worked on other platforms.</p>
<p>I am hoping that as <a href="https://github.com/LearnBoost/engine.io">Engine.io gets going</a>, the test suite will be fixed so that it can be run on other platforms. Otherwise, contributing improvements will be tricky/impossible since there is no way to tell whether the code works.</p>
<p><strong>2) More realistic performance test scenarios</strong></p>
<p>The current test scenario is rather limited in that it mostly tests performance in terms of establishing connections (without terminating them). I&#39;d love to hear more realistic scenario suggestions, particularly from people who have run into memory usage issues.</p>
<p><a href="https://github.com/mixu/siobench">siobench</a> is only a starting point: it&#39;s way better than just looking at htop and wondering whether performance was better in the last version or not. There are still specific questions that should be formulated as replicable tests.</p>
<p><strong>3) A polling transport that works on Node.js</strong></p>
<p>I did write tests for the xhr-polling transport for Socket.io as well. These showed much worse performance, around:</p>
<p><ul>
    <li>~ 550 connections on Socket.io 0.6.17 (vs ~2300 using WS)</li>
    <li>~ 450 connections on Socket.io 0.8.7 (vs ~ 1900 using WS)</li>
</ul>
However, the xhr-polling is severely broken in that it stops connecting after 4-5 connections on Node v0.4.12. So I had to force each load generating client to only make four connections and then spawn a new load generating process to work around the problem. I wouldn&#39;t vouch for the accuracy of the test with xhr-polling until the xhr-polling transport is fixed on Node when using socket.io-client (it&#39;s been broken for the last three releases, though).</p>
<p><strong>4) Comparative benchmarks</strong></p>
<p>Hopefully, this will help with performance testing new releases of Socket.io and other Comet libraries. Since the plan is that Engine.io will allow people to work with a lower level than Socket.io, there might be new performance oriented versions, and it would be useful to see benchmarks for those. Re: the other Node.js pubsub frameworks: I can&#39;t benchmark Faye, because it does not provide the right API out of the box, and Juggernaut uses Socket.io internally.</p>
<p>I&#39;m going to use siobench it for internal testing to ensure that the pubsub implementation I am working on (built over Socket.io) will not have performance regressions.</p>
<p>The full graphs are below. Please leave comments and suggestions for improvements - I am hoping that the developer community around Socket.io can help in improving the performance going forward, kind of like what Mozilla did with &quot;<a href="http://arewefastyet.com/">arewefastyet.com</a>&quot;.</p>
<p><strong>Socket.io 0.6.17 - Websockets - CPU usage and time</strong></p>
<p><a href="http://blog.mixu.net/files/2011/11/sio_617_cpu.png"><img class="alignnone size-full wp-image-2115" title="sio_617_cpu" src="http://blog.mixu.net/files/2011/11/sio_617_cpu.png" alt="" width="384" height="288" /></a> </p>
<p><a href="http://blog.mixu.net/files/2011/11/sio_617_cputime.png"><img class="alignnone size-full wp-image-2116" title="sio_617_cputime" src="http://blog.mixu.net/files/2011/11/sio_617_cputime.png" alt="" width="384" height="288" /></a></p>
<p><strong>Socket.io 0.6.17 - Websockets - resident set size</strong></p>
<p><strong><a href="http://blog.mixu.net/files/2011/11/sio_617_mem.png"><img title="sio_617_mem" src="http://blog.mixu.net/files/2011/11/sio_617_mem.png" alt="" width="384" height="288" /></a>
</strong></p>
<h2 id="comments">Comments</h2>
<p><strong><a href="#562" title="2012-01-02 19:44:45">Xananax</a>:</strong> Hey Mixu. My comment is totally unrelated to your post (which has been useful to me by the way). You don&#39;t know me, but I know you a little: I have been following your blog for a while now. But I never had a compelling reason to write something.
So even if it messes up a bit with the rigor of coder&#39;s comment that should always be constructive, I wanted to express my thanks as your writings have been an invaluable source of information and inspiration to me. Always interesting, always well written, always well presented. Keep up the good work!
Wish you the best for this new year.</p>
<p><strong><a href="#563" title="2012-01-05 13:02:35">Mikito Takada</a>:</strong> Thanks! This comment made my day. 2012 will be a great year!</p>
<p><strong><a href="#564" title="2012-01-09 14:58:37">Karen</a>:</strong> You can check with this: <a href="https://github.com/sockjs/sockjs-node">https://github.com/sockjs/sockjs-node</a> ?</p>
<p><strong><a href="#565" title="2012-03-05 15:05:58">Luc</a>:</strong> Hi,</p>
<p>I&#39;ve tried to fetch your project on github and when I do &quot;npm install&quot; I&#39;ve got an error fetching dependencies :</p>
<p>npm ERR! git clone git@github.com:mixu/nodeunit-runner.git Warning: Permanently added &#39;github.com&#39; (RSA) to the list of known hosts.
npm ERR! git clone git@github.com:mixu/nodeunit-runner.git Permission denied (publickey).
npm ERR! git clone git@github.com:mixu/nodeunit-runner.git fatal: The remote end hung up unexpectedly
npm ERR! Error: <code>git &quot;clone&quot; &quot;git@github.com:mixu/nodeunit-runner.git&quot; &quot;/tmp/npm-1330952664150/1330952664173-0.6050085364840925&quot;</code> failed with 128
npm ERR!     at ChildProcess. (/usr/lib/nodejs/npm/lib/utils/exec.js:49:20)
npm ERR!     at ChildProcess.emit (events.js:70:17)
npm ERR!     at maybeExit (child_process.js:361:16)
npm ERR!     at Socket. (child_process.js:466:7)
npm ERR!     at Socket.emit (events.js:67:17)
npm ERR!     at Array.0 (net.js:320:10)
npm ERR!     at EventEmitter._tickCallback (node.js:192:40)</p>
<p>Do you have any ideas ?</p>
<p><strong><a href="#581" title="2012-09-05 13:48:11">rufinus</a>:</strong> just change the github rep url to git://github.com/sockjs/sockjs-node.git in the config file for the npm he used his personal read/write url.</p>
<p>thanks for this article, its exactly what we have seen and couldnt believe it.</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>