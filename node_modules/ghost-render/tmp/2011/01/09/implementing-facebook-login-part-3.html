<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Implementing Facebook login (part 3)</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Implementing Facebook login (part 3)">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Implementing Facebook login (part 3)">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2011/01/09/implementing-facebook-login-part-3.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2011/01/09/implementing-facebook-login-part-3.html" itemprop="url">Implementing Facebook login (part 3)</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2011-01-09" itemprop="datePublished">January 09, 2011</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>Damn Facebook documentation! I finally managed to piece together a better picture - after first getting all that info in the previous posts (<a href="http://blog.mixu.net/2010/12/27/implementing-facebook-login-single-sign-on-part-1/">part 1</a>, <a href="http://blog.mixu.net/2011/01/03/implementing-facebook-login-part-2/">part 2</a>) - about how registration and login can be handled.</p>
<p>Basically, you can&#39;t use the registration tool unless you really want to replace your registration dialog with Facebook&#39;s own version. You can&#39;t redirect to it conditionally, e.g. if the user has Facebook and clicks the login button, since the login will already trigger the Facebook authorization process.</p>
<p>So unless you want two logins (Facebook login link and regular login form) and two registration links (regular registration page and Facebook register page), you can&#39;t use the registration tool. My ideal implementation would just have a single link for everything related to Facebook, but present the full registration form if the user clicks it and has not yet registered with my site... no luck.</p>
<p>Hence, I will do this the traditional way:</p>
<ul>
    <li>Use the Javascript SDK to render the Facebook Login link and popup.</li>
    <li>Ask for additional permissions on the Login.</li>
    <li>When the authorization returns, process the user login / registration.</li>
    <li>If the user wants to register using Facebook, then they will still need to fill in additional fields in a separate field after authorizing the information we can read from Facebook.</li>
</ul>
<h2>Preparations</h2>
<strong>Get an app<em>id and a secret from Facebook. </strong><a href="http://developers.facebook.com/setup/">Register your website/app here</a> to get an app<em>id and secret.

<strong>Add the Facebook namespace.</strong> Your HTML tag should contain the additional xmlns:fb -attribute so that the Facebook custom tags work with IE:


<code>html
&amp;lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:fb=&quot;http://www.facebook.com/2008/fbml&quot;&amp;gt;</code>

I did not know you could add XML namespaces to your documents and actually have custom tags which work in all current browsers, but since Facebook does it, it must have been tested well.
<h2>Rendering the Facebook login link and popup</h2>
[codesyntax lang=&quot;php&quot;]

<code>html
&amp;lt;div id=&quot;fb-root&quot;&amp;gt;&amp;lt;/div&amp;gt;
&amp;lt;script&amp;gt;
    window.fbAsyncInit = function() {
        FB.init({
            appId   : &#39;&amp;lt;?php echo $facebook-&amp;gt;getAppId(); ?&amp;gt;&#39;,
            session : &amp;lt;?php echo json_encode($session); ?&amp;gt;, // don&#39;t refetch the session when PHP already has it
            status  : true, // check login status
            cookie  : true, // enable cookies to allow the server to access the session
            xfbml   : true // parse XFBML
    });
    // whenever the user logs in, we tell our login service
    FB.Event.subscribe(&#39;auth.login&#39;, function() {
       window.location = &quot;&amp;lt;?php echo URL::site(&#39;/user/fb_login&#39;) ?&amp;gt;&quot;;
    });
  };

  (function() {
    var e = document.createElement(&#39;script&#39;);
    e.src = document.location.protocol + &#39;//connect.facebook.net/en_US/all.js&#39;;
    e.async = true;
    document.getElementById(&#39;fb-root&#39;).appendChild(e);
  }());
&amp;lt;/script&amp;gt;</code>

[/codesyntax]
<h2>Asking for additional permissions</h2>
You have to do this by adding the perms attribute to the fb:login-button tag. The links in the docs are broken, but <a href="http://developers.facebook.com/docs/reference/plugins/login">here is the page documenting the login button</a> and the <a href="http://developers.facebook.com/docs/authentication/permissions/">extended permissions you can ask for are listed here</a>.

We&#39;ll just ask for the email address:


<code>html
&amp;lt;fb:login-button perms=&quot;email&quot; size=&quot;large&quot;&amp;gt;&amp;lt;/fb:login-button&amp;gt;</code>

<h2>Processing the resulting login or registration</h2>
As you can see above, we subscribe to the auth.login event using Javascript and specify that on completion, the user will be redirected to /user/fb_login/.

On that page, we need to:
<ol>
    <li>Check whether a user account exists with the returned Facebook user id.</li>
    <li>If no user is found with the FB uid, retrieve the user&#39;s email via the Graph API and check whether a user exists with that email. If so, we will merge the user.</li>
    <li>If no user is found with the FB email, create a new account.</li>
    <li>If creating a new user fails, then accept defeat and show the regular registration page.</li>
</ol>
A complete implementation of this available from Bitbucket - soon! I&#39;m releasing it as part of my Useradmin module for Kohana 3.
<h2>Logging out</h2>
We need to handle logging out sensibly. I prefer that the user explicitly clicks a login button if they do not currently have a session with our application. Automatic relogin is confusing, particularly when logging out usually redirects to the login page.

So we need to handle the case where the person is connected (logged in to Facebook and authorized with us) by displaying a custom login button.

You can find the Facebook logo from the branding site. Of course, a Google search for facebook logo won&#39;t find it, so <a href="http://www.facebook.com/brandpermissions/logos.php">click here to get the image</a> that you are allowed to use for this purpose.

````js
    window.fbAsyncInit = function() {
        FB.init({
            appId   : &#39;&lt;?php echo Kohana::config(&#39;facebook&#39;)-&gt;app_id; ?&gt;&#39;,
            status  : true, // check login status
            cookie  : true, // enable cookies to allow the server to access the session
            xfbml   : true // parse XFBML
    });
    // whenever the user logs in, we tell our login service
    FB.Event.subscribe(&#39;auth.login&#39;, function() {
       window.location = &quot;&lt;?php echo URL::site(&#39;/user/fb_login&#39;) ?&gt;&quot;;
    });
    // if the user is already logged in, redirect them to the login action
    // they cannot reach the login page if they are already logged in
    // since login() redirects to profile if the user is logged in
   FB.getLoginStatus(function(response) {
     if (response.status == &#39;connected&#39;) {
        document.getElementById(&#39;fb-login-li&#39;).innerHTML = &#39;&lt;a href=&quot;&lt;?php echo URL::site(&#39;/user/fb_login&#39;) ?&gt;&quot;&gt;&lt;img src=&quot;/img/fb-login.png&quot;&gt;&lt;/a&gt;&#39;;
     } else {
        document.getElementById(&#39;fb-login-li&#39;).innerHTML = &#39;&lt;fb:login-button perms=&quot;email&quot; size=&quot;large&quot;&gt;&lt;?php echo </em></em>(&#39;Login / Register with Facebook&#39;)?&gt;&lt;/fb:login-button&gt;&#39;;
        FB.XFBML.parse(document.getElementById(&#39;fb-login-li&#39;));
     }
   });
  };
````

<h2>Appendix: all fb:login-button attributes</h2>

The Facebook documentation does not list the fb:login-button attributes, which is infuriating. I found a forum post (<a href="http://forum.developers.facebook.net/viewtopic.php?id=72137">here</a>), which documents the optional attributes of fb:login-button:

<ul>
    <li><strong>condition</strong>; string Indicates whether the button is visible or hidden.</li>
    <li><strong>size</strong>; string Specifies the size of the button. Specify icon to display a favicon only, or small, medium, large, or xlarge. (Default value is medium.)</li>
    <li><strong>autologoutlink</strong>; bool If true and the user is already connected and has a session, then the button image changes to indicate the user can log out. Clicking the button logs the user out of Facebook and all connected sessions. (Default value is false.)</li>
    <li><strong>background</strong>; string Specifies the button image to use that is anti-aliased to match the background of your site -- whether it&#39;s pure white, light, or dark. Specify white, dark, or light. (Default value is light.) Note: You don&#39;t specify this attribute if you are using v=&quot;2&quot;.</li>
</ul>

<h2 id="comments">Comments</h2>
<p><strong><a href="#288" title="2011-01-10 12:01:56">Facebook Lead Gen</a>:</strong> This series is great! I thank you for pointing out the fb:login-button attributes. :)</p>
<p>I&#39;m currently developing a PHP script that allows email marketers to capture user details to a database through a Facebook button (<a href="http://fbleadgen.com">http://fbleadgen.com</a>) but I&#39;ve bumped into a couple of hurdles along the way due to FB&#39;s (lack of) documentation!</p>
<p><strong><a href="#290" title="2011-01-11 19:38:03">Rishabh Tripathi</a>:</strong> thank you very much for this article. can you point out the server side coding in Ruby on rails or give me some url where I can find it as I google it alot but havent found any good documentation.</p>
<p>Thanks in advance</p>
<p><strong><a href="#291" title="2011-01-29 16:35:34">Max</a>:</strong> Nice tutorial,  you helped me to catch more concepts. Expecially thanks to your graph images on lexons 1 n 2,</p>
<p>It would have been nice of u to post a zip with a complete running example.</p>
<p>In the 3rd lesson i guess u miss some steps to make it complete. For example u use some PHP class defines some where without telling how to include them in the code... Kohana::config(&#39;facebook&#39;), or PHP::url...</p>
<p>Anyway this is definitely a positive comment ...thanks</p>
<p><strong><a href="#292" title="2011-01-29 22:33:10">Mikito Takada</a>:</strong> Yeah, I kind of ran out of time to write a tutorial covering 100% of the details; you should look at the code in my Kohana auth module for a complete working implementation with all the details worked out; covering every step would probably double the length of the post.</p>
<p>Specifically, see action_fb_login in (last function in the file):
<a href="https://github.com/mixu/useradmin/blob/master/modules/user/classes/controller/useradmin/user.php">https://github.com/mixu/useradmin/blob/master/modules/user/classes/controller/useradmin/user.php</a></p>
<p>and
<a href="https://github.com/mixu/useradmin/blob/master/modules/user/views/user/login.php">https://github.com/mixu/useradmin/blob/master/modules/user/views/user/login.php</a></p>
<p>Note that the $facebook is just an instance from Facebook&#39;s PHP SDK.</p>
<p><strong><a href="#293" title="2011-05-25 08:29:21">DD</a>:</strong> Can you explain how to implement it with registration-url?</p>
<p><strong><a href="#294" title="2011-10-12 19:21:05">Comprar Acciones</a>:</strong> I&#39;m trying to follow the instructions in this post but I can not register the website for a app_id. When I enter my username and password in facebook, facebook tells me that my user or password are not valid. Why?.</p>
<p><strong><a href="#295" title="2011-12-08 15:16:31">r0h1</a>:</strong> Well I&#39;m a bit confused, after this part 3. It seems that part 2 is not valid any more, or I did not understand correctly?
Let&#39;s take foursquare facebook login as example:
They have 2 separate sign up processes, one for fb (using the Javascript SDK) and the internal one.</p>
<ul>
<li>If you register with the fb login button (javascript sdk), on next page you need to fill email and password so it will create an internal 4sq account - connected to your fb one.
Then, every time you login through fb button, the fb authentication will be taken as &quot;valid&quot; by 4sq, without requiring any other input.
So at this point, all we need to do is managing the response cookie? Can you please explain how to do that, or link from fb documentation? Cause I cannot find it....</li>
</ul>
<p><strong><a href="#296" title="2012-01-03 20:54:12">Andrew</a>:</strong> Thanks, this worked for me!</p>
<p><strong><a href="#297" title="2012-02-29 12:09:03">Rajeev Jha</a>:</strong> Hi Mixu
I have found your post to be useful during my research. I have created a post about serve side implementation here :- <a href="http://rjha94.blogspot.in/2012/02/how-to-integrate-facebook-login-with.html">http://rjha94.blogspot.in/2012/02/how-to-integrate-facebook-login-with.html</a></p>
<p>I have added robust error handling (even facebook sample has error suppressing operators) and a nice working example. Thanks</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>