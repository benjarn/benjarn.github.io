<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Performance benchmarking the node.js backend of our 48h product, WeHearVoices.net</title>	

	<meta name="description" content="">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Performance benchmarking the node.js backend of our 48h product, WeHearVoices.net">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@username">
	<meta name="twitter:creator" content="@username">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Performance benchmarking the node.js backend of our 48h product, WeHearVoices.net">
    <meta property="og:description" content="">

    <link rel="stylesheet" href="/assets/css/style.css">

    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Mixu&#39;s blog" href="/rss/">
<link rel="canonical" href="http://localhost:5000//2011/01/17/performance-benchmarking-the-node-js-backend-of-our-48h-product-wehearvoices-net.md" />	
</head>
<body class="post-template">
	
<main id="container" role="main">
	<header class="header" role="banner" style="background-image: url(/assets/img/header.jpg);">
		<h1 class="blog-title">
			<a href="http://localhost:5000">Mixu&#x27;s blog</a>
		</h1>
		<div class="blog-description">A blog</div>
	</header>
	<nav class="menu" role="navigation">
		<a href="#">Home</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">About</a>
		<span class="delimiter">&#8226;</span>
		<a href="#">Contacts</a>
	</nav>
	<section class="post-full">
		<article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post">
			<header class="post-header">        		
    			<h2 itemprop="name headline" class="post-title">
    				<a href="/2011/01/17/performance-benchmarking-the-node-js-backend-of-our-48h-product-wehearvoices-net.html" itemprop="url">Performance benchmarking the node.js backend of our 48h product, WeHearVoices.net</a>
    			</h2>
    			<div class="post-meta">
        			<time datetime="2011-01-17" itemprop="datePublished">January 17, 2011</time>
        		</div>
        		<hr>
    		</header>
    		<section itemprop="articleBody" class="post-content">
    			<p>I decided to spend some time looking into improving the performance of the node.js backend of our 48h hackathon product <a href="http://wehearvoices.net/">We Hear Voices</a> - a dead-simple but slick feedback tool for websites and web apps (go get it for your site ;).</p>
<p>Anyway, I didn&#39;t do any performance optimization during <a href="http://www.garage48.org/events/helsinki-2011">Garage48</a> since we were adding functionality rather than worrying about performance; but as you can see at the end of this post the backend is now optimized for much greater performance.</p>
<p>Here are my initial benchmarks, node.js vs Django:</p>
<p><a href="http://blog.mixu.net/files/2011/01/initial-out.png"><img class="alignnone size-full wp-image-1623" title="initial-out" src="http://blog.mixu.net/files/2011/01/initial-out.png" alt="" width="640" height="480" /></a></p>
<p>The unoptimized implementation for the backend is hitting the database on every request and creating new MySQL client connections on each load; it does not use any caching. Given this, the performance fo node is almost 190 requests per slower than Django:</p>
<p>Node.js requests per second:    275.41 [#/sec] (mean)</p>
<p>Python (front page of site) requests per second:    454.49 [#/sec] (mean)</p>
<p>I decided to tackle the client connections first by implementing MySQL client pooling. Instead of creating new MySQL connections, the server uses a pool of 10 MySQL connections to perform queries.</p>
<p><a href="http://blog.mixu.net/files/2011/01/pool-out.png"><img class="alignnone size-full wp-image-1626" title="pool-out" src="http://blog.mixu.net/files/2011/01/pool-out.png" alt="" width="640" height="480" /></a></p>
<p>The resulting performance takes Node.js to a similar level of performance as Django. Note that those queries are still there, loaded each time and we have only eliminated the latency from connecting to MySQL.</p>
<p>Node.js requests per second:    417.23 [#/sec] (mean)</p>
<p>Next, I implemented caching for questions, with a cache lifetime of 30 minutes:</p>
<p><a href="http://blog.mixu.net/files/2011/01/cache1-out.png"><img class="alignnone size-full wp-image-1627" title="cache1-out" src="http://blog.mixu.net/files/2011/01/cache1-out.png" alt="" width="640" height="480" /></a></p>
<p>Now node.js is twice as fast as Django. Note that in this naive caching, the result is not expired immediately if the user changes the questions. For that, we need to expose a way for the frontend to tell the backend that the user updated the question - which is rather simple to implement (later).</p>
<p>Node.js requests per second:    848.21 [#/sec] (mean)</p>
<p>I added some more improvements:</p>
<p><a href="http://blog.mixu.net/files/2011/01/cache2-out.png"><img class="alignnone size-full wp-image-1629" title="cache2-out" src="http://blog.mixu.net/files/2011/01/cache2-out.png" alt="" width="640" height="480" /></a></p>
<p>This improves the performance by a further 300 requests per second. There is some degradation at the very slowest requests, but most requests are faster (98% complete in less than 192 ms). I still need to look into the performance degradation, although the requests per second tended to remain rather constant even when I tested it with 20 000 requests at concurrency of 1000 simultaneous requests.</p>
<p>Node.js requests per second:    1135.72 [#/sec] (mean)</p>
<p>Then I refactored the code a bit more, and added request-level caching (which runs the minimum amount of logic while taking into account the necessity of getting and setting per-user cookies and per-referrer questions).</p>
<p><a href="http://blog.mixu.net/files/2011/01/final-x.png"><img class="alignnone size-full wp-image-1638" title="final-x" src="http://blog.mixu.net/files/2011/01/final-x.png" alt="" width="640" height="480" /></a></p>
<p>Node.js requests per second:    1879.86 [#/sec] (mean)</p>
<p>Time per request:       53.196 [ms] (mean)</p>
<p>Time per request:       0.532 [ms] (mean, across all concurrent requests)</p>
<p>The very lowest curve, nodejs-hello-world is the performance of a node.js server which simply returns Hello World. We aren&#39;t quite at that level since we need to some routing and cookie setting/getting.</p>
<p>There are a few special cases where performance is somewhere between nodejs-p-cache-2 (notably if you have two identical URLs mapped to different questions) and nodejs-p-final; but even those get cached after a couple of questions.</p>
<p>However, I am satisfied that any of our early users will get good performance out of the service. Testing the most recent code with 1000 concurrent users gives similar performance (50-60 ms) with a couple of outliers which take longer.</p>
<p><strong>What this means that even if you send us a <em>continuous </em>stream of traffic where 1800 users load a page each second, we can still cope with it :)</strong> (with some caveats, so maybe 1200+ requests per second would be more appropriate)<strong>.</strong> I think the next problem is to get that traffic...</p>
<script src="http://static.wehearvoices.net/widget.js" type="text/javascript"></script>
 <script src="http://widget.wehearvoices.net/node/init.js?user_id=1757eb62-218b-11e0-9884-fefdb24f91c5" type="text/javascript"></script>

<h2 id="comments">Comments</h2>
<p><strong><a href="#423" title="2011-01-31 23:38:57">Ryan Dahl</a>:</strong> What version of Node is this? What mysql library are you using and which version of it?</p>
<p><strong><a href="#424" title="2011-01-31 23:55:27">Mikito Takada</a>:</strong> Node v.0.3.4 with felixge&#39;s node-mysql v0.9.0 on a Linode 512.</p>
<p>And if I may, let me do my best impression of a fan girl: OMG OMG OMG! It&#39;s Ryan Dahl! You&#39;re you! Huge fan.</p>
<p><strong><a href="#425" title="2011-10-15 21:19:58">Anthony Webb</a>:</strong> What did you use for a connection pool with mysql?  Also interested in how you were doing the caching.</p>
<p><strong><a href="#426" title="2011-11-04 08:27:18">David</a>:</strong> What are you running Django on?  If you&#39;re just running the built in Django server I would absolutely expect it to be slower...  The built in server is purely for development and mostly unoptimized given that Django is a framework and not a server.  If you were running Django under nginx or maybe something like gunicorn you may find it runs significantly faster, assuming you were running the django dev server.  Incidentally, that would actually make it a fair test as django makes no claims that its built in server is production capable, stating quite the opposite in the docs.</p>
<p><strong><a href="#427" title="2012-01-11 18:17:16">Bart Czernicki</a>:</strong> Stupid question...but the graph(s) you show are highly skewed...can&#39;t u also implement caching and pooling in Django?? (rhetorical question).</p>
<p>It would have been nice to see those performance improvements applied to BOTH frameworks/products.  Its like me saying .NET is better than Java because I can do async programming/Generics/use advanced data structures etc. (examples both languages have).</p>
<p><strong><a href="#428" title="2012-01-12 12:57:51">Mikito Takada</a>:</strong> To put this in context: Node was a lot newer a year ago and the point of the article was just to see what kind of performance we could get out of Node with a few optimizations. The Django curve is there just to provide some context; it was running behind nginx if my memory serves me right.</p>

    		</section>
    		<footer class="post-footer">
    			<div itemscope itemprop="author" itemtype="http://schema.org/Person" class="post-author">
	                	<img itemprop="image" src="http://www.gravatar.com/avatar/F0AF2953911805542C66FD43B2F8FC38?s=155" alt="Mixu" class="post-author-avatar">
					<div class="post-author-info">
		              	<span itemprop="name">Mixu</span>
		              	<p itemprop="description" class="post-author-bio">Node.js developer</p>
	              	</div>
    			</div>
    		</footer>
		</article>
		
		<section itemprop="comment" class="post-comments">
			<div id="disqus_thread"></div>
			<script type="text/javascript">            
				var disqus_shortname = 'example';
		
			    (function() {
			        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			    })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</section>	</section>

	<footer class="footer" role="contentinfo">
		<div class="social-links-line"></div>
		<section class="social-links">
	        <div class="social-links-inner">
	        	<a class="icon icon-feed" href="http://localhost:5000/rss/" target="_blank">
	        		<i class="fa fa-rss"></i>
	        	</a>
	        	
	        	<a class="icon icon-twitter" href="http://twitter.com/" target="_blank">				
	        		<i class="fa fa-twitter"></i>
	        	</a>
	        	
	        	<a class="icon icon-facebook" href="http://facebook.com/" target="_blank">
	        		<i class="fa fa-facebook"></i>
	        	</a>
	        	
	        	<a class="icon icon-google-plus" href="http://plus.google.com/" target="_blank">
	        		<i class="fa fa-google-plus"></i>
	        	</a>
	        	
	        	<a class="icon icon-dribbble" href="http://dribbble.com/" target="_blank">
	        		<i class="fa fa-dribbble"></i>
	        	</a>
	        	
	        	<a class="icon icon-flickr" href="http://flickr.com/" target="_blank">
	        		<i class="fa fa-flickr"></i>
	        	</a>
	        	
	        	<a class="icon icon-foursquare" href="http://foursquare.com/" target="_blank">
	        		<i class="fa fa-foursquare"></i>
	        	</a>
	        	
	        	<a class="icon icon-instagram" href="http://instagram.com/" target="_blank">
	        		<i class="fa fa-instagram"></i>
	        	</a>
	        	
	        	<a class="icon icon-github" href="http://github.com/" target="_blank">
	        		<i class="fa fa-github"></i>
	        	</a>
	        	
	        	<a class="icon icon-tumblr" href="http://tumblr.com/" target="_blank">
	        		<i class="fa fa-tumblr"></i>
	        	</a>
	        	
	        	<a class="icon icon-pinterest" href="http://pinterest.com/" target="_blank">
	        		<i class="fa fa-pinterest"></i>
	        	</a>
	        	
	        	<a class="icon icon-linkedin" href="http://linkedin.com/" target="_blank">
	        		<i class="fa fa-linkedin"></i>
	        	</a>
	        	
	        	<a class="icon icon-vk" href="http://vk.com/" target="_blank">
	        		<i class="fa fa-vk"></i>
	        	</a>        </div>               
	    </section>
	</footer></main>

	<script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.min.js"></script>
</body>
</html>